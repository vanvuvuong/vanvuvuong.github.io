<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=vi><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc - Kaizen - tốt hơn mỗi ngày</title><meta name=author content="Kaizen Teams"><meta name=description content="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc"><meta name=keywords content='ai generated post'><meta itemprop=name content="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc"><meta itemprop=description content="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc"><meta itemprop=datePublished content="2025-12-11T11:17:23+07:00"><meta itemprop=dateModified content="2025-12-11T16:05:24+07:00"><meta itemprop=wordCount content="8515"><meta itemprop=keywords content="Ai Generated Post"><meta property="og:url" content="https://vanvuvuong.github.io/bai-viet/khoa-hoc-may-tinh/linux-cli/selinux/"><meta property="og:site_name" content="Kaizen - tốt hơn mỗi ngày"><meta property="og:title" content="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc"><meta property="og:description" content="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc"><meta property="og:locale" content="vi"><meta property="og:type" content="article"><meta property="article:section" content="bai-viet"><meta property="article:published_time" content="2025-12-11T11:17:23+07:00"><meta property="article:modified_time" content="2025-12-11T16:05:24+07:00"><meta property="article:tag" content="Ai Generated Post"><meta name=twitter:card content="summary"><meta name=twitter:title content="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc"><meta name=twitter:description content="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc"><meta name=application-name content="Kaizen - tốt hơn mỗi ngày"><meta name=apple-mobile-web-app-title content="Kaizen - tốt hơn mỗi ngày"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#2d89ef"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#FF7359><link rel=manifest href=/site.webmanifest><link rel=canonical type=text/html href=https://vanvuvuong.github.io/bai-viet/khoa-hoc-may-tinh/linux-cli/selinux/ title="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc - Kaizen - tốt hơn mỗi ngày"><link rel=prev type=text/html href=https://vanvuvuong.github.io/bai-viet/khoa-hoc-may-tinh/linux-cli/encryption-and-security/ title="Linux Cryptography & Security Tools - Hướng Dẫn Chuyên Sâu"><link rel=next type=text/html href=https://vanvuvuong.github.io/bai-viet/khoa-hoc-may-tinh/linux-cli/file-and-folder/ title="Find, Ln, Lsof, Tar, Chmod - Hướng Dẫn Chuyên Sâu"><link rel=stylesheet href=/css/config.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Selinux \u0026 Apparmor - Kiểm Soát Truy Cập Bắt Buộc","inLanguage":"vi","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/vanvuvuong.github.io\/bai-viet\/khoa-hoc-may-tinh\/linux-cli\/selinux\/"},"image":[{"@type":"ImageObject","url":"https:\/\/vanvuvuong.github.io\/images\/avatar.jpeg","width":330,"height":330}],"genre":"posts","keywords":"ai generated post","wordcount":8515,"url":"https:\/\/vanvuvuong.github.io\/bai-viet\/khoa-hoc-may-tinh\/linux-cli\/selinux\/","datePublished":"2025-12-11T11:17:23+07:00","dateModified":"2025-12-11T16:05:24+07:00","publisher":{"@type":"Organization","name":"Kaizen","logo":{"@type":"ImageObject","url":"https:\/\/vanvuvuong.github.io\/images\/avatar.jpeg","width":330,"height":330}},"author":{"@type":"Person","name":"Kaizen Teams"},"description":"Selinux \u0026 Apparmor - Kiểm Soát Truy Cập Bắt Buộc"}</script><script src=/js/head/color-scheme.min.js></script></head><body data-instant-intensity=viewport data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Kaizen - tốt hơn mỗi ngày"><img class=logo src=/images/kaizen-logo.png alt="Kaizen - tốt hơn mỗi ngày" height=32 width=32><span class=header-title-text>Kaizen</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/gioi-thieu><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> Giới thiệu</a></li><li class="menu-item has-children"><a class=menu-link href=/bai-viet><i class="fa-solid fa-newspaper fa-fw fa-sm" aria-hidden=true></i> Bài viết</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/bai-viet/khoa-hoc-may-tinh><i class="fa-solid fa-laptop fa-fw fa-sm" aria-hidden=true></i> Khoa học máy tính</a></li><li class=menu-item><a class=menu-link href=/bai-viet/cuoc-song><i class="fa-solid fa-life-ring fa-fw fa-sm" aria-hidden=true></i> Cuộc sống</a></li><li class=menu-item><a class=menu-link href=/bai-viet/hoc-vien-luat-tu-nhien><i class="fa-solid fa-dragon fa-fw fa-sm" aria-hidden=true></i> Học viện luật tự nhiên</a></li><li class=menu-item><a class=menu-link href=/collections><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> Bộ sưu tập</a></li><li class=menu-item><a class=menu-link href=/tags><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li></ul></li><li class=menu-item><a class=menu-link href=/sach-hay><i class="fa-solid fa-book fa-fw fa-sm" aria-hidden=true></i> Sách hay</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder="Tìm tiêu đề hoặc nội dung..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title="Tìm kiếm"><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Xoá><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title="Đổi chủ đề"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Kaizen - tốt hơn mỗi ngày"><img class=logo src=/images/kaizen-logo.png alt="Kaizen - tốt hơn mỗi ngày" height=26 width=26><span class=header-title-text>Kaizen</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Tìm tiêu đề hoặc nội dung..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title="Tìm kiếm"><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Xoá><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Huỷ</a></li><li class=menu-item><a class=menu-link href=/gioi-thieu><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> Giới thiệu</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/bai-viet><i class="fa-solid fa-newspaper fa-fw fa-sm" aria-hidden=true></i> Bài viết</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/bai-viet/khoa-hoc-may-tinh><i class="fa-solid fa-laptop fa-fw fa-sm" aria-hidden=true></i> Khoa học máy tính</a></li><li class=menu-item><a class=menu-link href=/bai-viet/cuoc-song><i class="fa-solid fa-life-ring fa-fw fa-sm" aria-hidden=true></i> Cuộc sống</a></li><li class=menu-item><a class=menu-link href=/bai-viet/hoc-vien-luat-tu-nhien><i class="fa-solid fa-dragon fa-fw fa-sm" aria-hidden=true></i> Học viện luật tự nhiên</a></li><li class=menu-item><a class=menu-link href=/collections><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> Bộ sưu tập</a></li><li class=menu-item><a class=menu-link href=/tags><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> Tags</a></li></ul></li><li class=menu-item><a class=menu-link href=/sach-hay><i class="fa-solid fa-book fa-fw fa-sm" aria-hidden=true></i> Sách hay</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title="Đổi chủ đề"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=fi-container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="Bộ sưu tập"><div class="details collection-details open"><div class="details-summary collection-summary"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i>
<span class=collection-name title="Bộ sưu tập">Linux Cli</span>
<span class=collection-count>11</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content collection-content"><nav><ul class=collection-list><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/shell-co-ban/ title="Những Điều Cơ Bản Về Bash & Fish Shell Trong Linux">Những Điều Cơ Bản Về Bash & Fish Shell Trong Linux</a></li><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/grep-diff-sort/ title="Grep, Sort, Diff - Hướng Dẫn Chuyên Sâu">Grep, Sort, Diff - Hướng Dẫn Chuyên Sâu</a></li><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/network/ title="Linux Network Commands - Hướng Dẫn Chuyên Sâu">Linux Network Commands - Hướng Dẫn Chuyên Sâu</a></li><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/process-service-log/ title="Process Management, Systemd & Logging - Hướng Dẫn Chuyên Sâu">Process Management, Systemd & Logging - Hướng Dẫn Chuyên Sâu</a></li><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/regex-awk-sed/ title="Awk, Sed & Regex - Hướng Dẫn Chuyên Sâu Cho System Engineer">Awk, Sed & Regex - Hướng Dẫn Chuyên Sâu Cho System Engineer</a></li><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/storage/ title="Disk, Storage & Filesystem - Hướng Dẫn Chuyên Sâu">Disk, Storage & Filesystem - Hướng Dẫn Chuyên Sâu</a></li><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/user-group/ title="Linux User & Group Management - Hướng Dẫn Chuyên Sâu">Linux User & Group Management - Hướng Dẫn Chuyên Sâu</a></li><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/encryption-and-security/ title="Linux Cryptography & Security Tools - Hướng Dẫn Chuyên Sâu">Linux Cryptography & Security Tools - Hướng Dẫn Chuyên Sâu</a></li><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/package-manager/ title="Linux Package Management - Hướng Dẫn Chuyên Sâu">Linux Package Management - Hướng Dẫn Chuyên Sâu</a></li><li class=collection-item><span class=active title="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc">Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc</span></li><li class=collection-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/file-and-folder/ title="Find, Ln, Lsof, Tar, Chmod - Hướng Dẫn Chuyên Sâu">Find, Ln, Lsof, Tar, Chmod - Hướng Dẫn Chuyên Sâu</a></li></ul><div class=collection-nav-simple><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/package-manager/ class=collection-nav-item rel=prev title="Linux Package Management - Hướng Dẫn Chuyên Sâu"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i></a><span class=text-secondary>10/11</span><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/file-and-folder/ class=collection-nav-item rel=next title="Find, Ln, Lsof, Tar, Chmod - Hướng Dẫn Chuyên Sâu"><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></nav></div></div><div class="details related-details open"><div class="details-summary related-summary"><i class="fa-solid fa-fire fa-fade text-danger fa-fw" aria-hidden=true></i>
<span class=related-title>Nội dung liên quan</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content related-content"><ul class=related-list><li class=related-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/encryption-and-security/ title="Linux Cryptography & Security Tools - Hướng Dẫn Chuyên Sâu">Linux Cryptography & Security Tools - Hướng Dẫn Chuyên Sâu</a></li><li class=related-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/package-manager/ title="Linux Package Management - Hướng Dẫn Chuyên Sâu">Linux Package Management - Hướng Dẫn Chuyên Sâu</a></li><li class=related-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/user-group/ title="Linux User & Group Management - Hướng Dẫn Chuyên Sâu">Linux User & Group Management - Hướng Dẫn Chuyên Sâu</a></li><li class=related-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/storage/ title="Disk, Storage & Filesystem - Hướng Dẫn Chuyên Sâu">Disk, Storage & Filesystem - Hướng Dẫn Chuyên Sâu</a></li><li class=related-item><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/regex-awk-sed/ title="Awk, Sed & Regex - Hướng Dẫn Chuyên Sâu Cho System Engineer">Awk, Sed & Regex - Hướng Dẫn Chuyên Sâu Cho System Engineer</a></li></ul></div></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://vanvuvuong.github.io title="Tác giả" target=_blank rel="external nofollow noopener noreferrer author" class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
Kaizen Teams</a></span><span class=post-included-in>&nbsp;trong <a href=/collections/linux-cli/ class=post-collection title="Bộ sưu tập - Linux Cli"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> Linux Cli</a></span></div><div class=post-meta-line><span title="đăng ngày 2025-12-11 11:17:23"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2025-12-11>2025-12-11</time></span>&nbsp;<span title="Cập nhật ngày 2025-12-11 16:05:24"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2025-12-11>2025-12-11</time></span>&nbsp;<span title="8515 từ"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>Khoảng 8600 từ</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>40 phút</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>Nội dung</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#phần-1-nền-tảng-mac>PHẦN 1: NỀN TẢNG MAC</a><ul><li><a href=#11-dac-vs-mac>1.1 DAC vs MAC</a></li><li><a href=#12-mô-hình-bảo-mật>1.2 Mô hình bảo mật</a></li><li><a href=#13-linux-security-modules-lsm>1.3 Linux Security Modules (LSM)</a></li></ul></li><li><a href=#phần-2-kiến-trúc-selinux>PHẦN 2: KIẾN TRÚC SELINUX</a><ul><li><a href=#21-thành-phần-cốt-lõi>2.1 Thành phần cốt lõi</a></li><li><a href=#22-security-context>2.2 Security Context</a></li><li><a href=#23-type-enforcement>2.3 Type Enforcement</a></li><li><a href=#24-file-context-database>2.4 File Context Database</a></li></ul></li><li><a href=#phần-3-vận-hành-selinux>PHẦN 3: VẬN HÀNH SELINUX</a><ul><li><a href=#31-chế-độ-selinux>3.1 Chế độ SELinux</a></li><li><a href=#32-policy-types>3.2 Policy Types</a></li><li><a href=#33-booleans>3.3 Booleans</a></li><li><a href=#34-port-context>3.4 Port Context</a></li><li><a href=#35-user-mappings>3.5 User Mappings</a></li></ul></li><li><a href=#phần-4-xử-lý-sự-cố-selinux>PHẦN 4: XỬ LÝ SỰ CỐ SELINUX</a><ul><li><a href=#41-tìm-avc-denials>4.1 Tìm AVC Denials</a></li><li><a href=#42-công-cụ-phân-tích>4.2 Công cụ phân tích</a></li><li><a href=#43-quy-trình-xử-lý-sự-cố>4.3 Quy trình xử lý sự cố</a></li><li><a href=#44-vấn-đề-phổ-biến-và-giải-pháp>4.4 Vấn đề phổ biến và giải pháp</a></li></ul></li><li><a href=#phần-5-viết-policy-selinux>PHẦN 5: VIẾT POLICY SELINUX</a><ul><li><a href=#51-cấu-trúc-module>5.1 Cấu trúc Module</a></li><li><a href=#52-sử-dụng-audit2allow-an-toàn>5.2 Sử dụng audit2allow an toàn</a></li></ul></li><li><a href=#phần-6-kiến-trúc-apparmor>PHẦN 6: KIẾN TRÚC APPARMOR</a><ul><li><a href=#61-pathname-based-mac>6.1 Pathname-based MAC</a></li><li><a href=#62-thành-phần-apparmor>6.2 Thành phần AppArmor</a></li><li><a href=#63-chế-độ-profile>6.3 Chế độ Profile</a></li><li><a href=#64-cú-pháp-profile>6.4 Cú pháp Profile</a></li></ul></li><li><a href=#phần-7-vận-hành-apparmor>PHẦN 7: VẬN HÀNH APPARMOR</a><ul><li><a href=#71-quản-lý-chế-độ>7.1 Quản lý chế độ</a></li><li><a href=#72-tạo-profile-mới>7.2 Tạo profile mới</a></li><li><a href=#73-cập-nhật-profile>7.3 Cập nhật profile</a></li><li><a href=#74-xem-và-debug-violations>7.4 Xem và debug violations</a></li></ul></li><li><a href=#phần-8-viết-profile-apparmor>PHẦN 8: VIẾT PROFILE APPARMOR</a><ul><li><a href=#81-profile-hoàn-chỉnh>8.1 Profile hoàn chỉnh</a></li><li><a href=#82-abstractions>8.2 Abstractions</a></li><li><a href=#83-tunables>8.3 Tunables</a></li><li><a href=#84-local-customizations>8.4 Local customizations</a></li></ul></li><li><a href=#phần-9-so-sánh--trường-hợp-sử-dụng>PHẦN 9: SO SÁNH & TRƯỜNG HỢP SỬ DỤNG</a><ul><li><a href=#91-bảng-so-sánh-chi-tiết>9.1 Bảng so sánh chi tiết</a></li><li><a href=#92-khi-nào-dùng-gì>9.2 Khi nào dùng gì</a></li><li><a href=#93-so-sánh-theo-use-case>9.3 So sánh theo use case</a></li></ul></li><li><a href=#phần-10-quy-trình-thực-tế>PHẦN 10: QUY TRÌNH THỰC TẾ</a><ul><li><a href=#101-script-triển-khai-selinux>10.1 Script triển khai SELinux</a></li><li><a href=#102-script-triển-khai-apparmor>10.2 Script triển khai AppArmor</a></li><li><a href=#103-script-kiểm-tra-bảo-mật>10.3 Script kiểm tra bảo mật</a></li></ul></li><li><a href=#tóm-tắt-nhanh>TÓM TẮT NHANH</a><ul><li><a href=#lệnh-selinux>Lệnh SELinux</a></li><li><a href=#lệnh-apparmor>Lệnh AppArmor</a></li><li><a href=#hướng-dẫn-chọn-nhanh>Hướng dẫn chọn nhanh</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><h2 class=heading-element id=phần-1-nền-tảng-mac><span>PHẦN 1: NỀN TẢNG MAC</span>
<a href=#ph%e1%ba%a7n-1-n%e1%bb%81n-t%e1%ba%a3ng-mac class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=11-dac-vs-mac><span>1.1 DAC vs MAC</span>
<a href=#11-dac-vs-mac class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│              DAC - Kiểm Soát Truy Cập Tùy Ý                 │
</span></span><span class=line><span class=cl>│              (Discretionary Access Control)                 │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Định nghĩa: Chủ sở hữu tài nguyên quyết định ai được truy cập.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│ CÁCH HOẠT ĐỘNG                                              │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   Chủ sở hữu file ──► Đặt quyền (chmod 755)                 │
</span></span><span class=line><span class=cl>│                  ──► Quyết định ai đọc/ghi/chạy             │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   Ví dụ: chmod, chown, ACL                                  │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│ VẤN ĐỀ CỦA DAC                                              │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   1. Root bỏ qua tất cả                                     │
</span></span><span class=line><span class=cl>│      Process chạy root → toàn quyền hệ thống                │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   2. Process bị chiếm quyền = thảm họa                      │
</span></span><span class=line><span class=cl>│      Lỗ hổng trong httpd → attacker có quyền httpd          │
</span></span><span class=line><span class=cl>│      httpd chạy root → attacker có root                     │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   3. Không có nguyên tắc đặc quyền tối thiểu                │
</span></span><span class=line><span class=cl>│      Process có nhiều quyền hơn cần thiết                   │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│              MAC - Kiểm Soát Truy Cập Bắt Buộc              │
</span></span><span class=line><span class=cl>│              (Mandatory Access Control)                     │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Định nghĩa: Hệ thống (policy) quyết định ai được truy cập.
</span></span><span class=line><span class=cl>Kể cả root cũng bị hạn chế bởi policy!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│ CÁCH HOẠT ĐỘNG                                              │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   Yêu cầu truy cập                                          │
</span></span><span class=line><span class=cl>│         │                                                   │
</span></span><span class=line><span class=cl>│         ▼                                                   │
</span></span><span class=line><span class=cl>│   ┌───────────┐     ┌───────────┐                           │
</span></span><span class=line><span class=cl>│   │ Kiểm tra  │ ──► │ Kiểm tra  │ ──► Cho phép/Từ chối      │
</span></span><span class=line><span class=cl>│   │   DAC     │     │   MAC     │                           │
</span></span><span class=line><span class=cl>│   └───────────┘     └───────────┘                           │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   Cả hai đều phải cho phép mới được truy cập!               │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│ LỢI ÍCH CỦA MAC                                             │
</span></span><span class=line><span class=cl>├─────────────────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   1. Root bị hạn chế bởi policy                             │
</span></span><span class=line><span class=cl>│      root không thể làm mọi thứ                             │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   2. Ngăn chặn leo thang đặc quyền                          │
</span></span><span class=line><span class=cl>│      httpd bị chiếm → chỉ làm được những gì httpd_t cho phép│
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   3. Đặc quyền tối thiểu                                    │
</span></span><span class=line><span class=cl>│      Mỗi process chỉ có quyền cần thiết                     │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   4. Defense in depth (phòng thủ nhiều lớp)                 │
</span></span><span class=line><span class=cl>│      DAC thất bại → MAC vẫn bảo vệ                          │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                    LUỒNG QUYẾT ĐỊNH                         │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     Yêu cầu truy cập (process → file/socket/...)
</span></span><span class=line><span class=cl>                    │
</span></span><span class=line><span class=cl>                    ▼
</span></span><span class=line><span class=cl>            ┌───────────────┐
</span></span><span class=line><span class=cl>            │  Kiểm tra DAC │
</span></span><span class=line><span class=cl>            │ (quyền Unix)  │
</span></span><span class=line><span class=cl>            └───────┬───────┘
</span></span><span class=line><span class=cl>                    │
</span></span><span class=line><span class=cl>           Từ chối ◄┴► Cho phép
</span></span><span class=line><span class=cl>              │            │
</span></span><span class=line><span class=cl>              ▼            ▼
</span></span><span class=line><span class=cl>           TỪ CHỐI   ┌───────────────┐
</span></span><span class=line><span class=cl>                     │  Kiểm tra MAC │
</span></span><span class=line><span class=cl>                     │   (SELinux/   │
</span></span><span class=line><span class=cl>                     │   AppArmor)   │
</span></span><span class=line><span class=cl>                     └───────┬───────┘
</span></span><span class=line><span class=cl>                             │
</span></span><span class=line><span class=cl>                    Từ chối ◄┴► Cho phép
</span></span><span class=line><span class=cl>                       │            │
</span></span><span class=line><span class=cl>                       ▼            ▼
</span></span><span class=line><span class=cl>                    TỪ CHỐI     CHO PHÉP</span></span></code></pre></div><h3 class=heading-element id=12-mô-hình-bảo-mật><span>1.2 Mô hình bảo mật</span>
<a href=#12-m%c3%b4-h%c3%acnh-b%e1%ba%a3o-m%e1%ba%adt class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>              <span class=n>CÁC</span> <span class=n>MÔ</span> <span class=n>HÌNH</span> <span class=n>BẢO</span> <span class=n>MẬT</span>                            <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>TYPE</span> <span class=n>ENFORCEMENT</span> <span class=p>(</span><span class=n>SELinux</span><span class=p>)</span>                                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Mô</span> <span class=n>hình</span><span class=p>:</span> <span class=err>Đồ</span> <span class=n>thị</span> <span class=n>có</span> <span class=n>hướng</span><span class=p>,</span> <span class=n>gán</span> <span class=n>nhãn</span>                          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>┌─────────┐</span>    <span class=n>cho</span> <span class=n>phép</span> <span class=err>đọ</span><span class=n>c</span>    <span class=err>┌─────────┐</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span> <span class=n>httpd_t</span> <span class=err>│───────────────────►│</span><span class=n>httpd_</span>   <span class=err>│</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span><span class=p>(</span><span class=n>domain</span><span class=p>)</span> <span class=err>│</span>                    <span class=err>│</span><span class=n>sys_</span>     <span class=err>│</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└─────────┘</span>                    <span class=err>│</span><span class=n>content_t</span><span class=err>│</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>        <span class=err>│</span>                         <span class=err>└─────────┘</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>        <span class=err>│</span> <span class=n>cho</span> <span class=n>phép</span> <span class=n>ghi</span>                                       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>        <span class=err>▼</span>                                                    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>┌─────────┐</span>                                               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span><span class=n>httpd_</span>   <span class=err>│</span>                                               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span><span class=n>log_t</span>    <span class=err>│</span>                                               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└─────────┘</span>                                               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Thuật</span> <span class=n>toán</span> <span class=n>kiểm</span> <span class=n>tra</span><span class=p>:</span>                                        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>1.</span> <span class=n>Lấy</span> <span class=n>type</span> <span class=n>của</span> <span class=n>subject</span> <span class=p>(</span><span class=n>process</span><span class=p>):</span> <span class=n>httpd_t</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>2.</span> <span class=n>Lấy</span> <span class=n>type</span> <span class=n>của</span> <span class=n>object</span> <span class=p>(</span><span class=n>file</span><span class=p>):</span> <span class=n>httpd_sys_content_t</span>        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>3.</span> <span class=n>Tra</span> <span class=n>bảng</span> <span class=nb>hash</span><span class=p>:</span> <span class=p>(</span><span class=n>httpd_t</span><span class=p>,</span> <span class=n>httpd_sys_content_t</span><span class=p>,</span> <span class=n>file</span><span class=p>)</span>    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>4.</span> <span class=n>Trả</span> <span class=n>về</span> <span class=n>quyền</span><span class=p>:</span> <span class=p>{</span><span class=n>read</span><span class=p>,</span> <span class=n>getattr</span><span class=p>,</span> <span class=n>open</span><span class=p>}</span>                    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=err>Độ</span> <span class=n>phức</span> <span class=n>tạp</span><span class=p>:</span> <span class=n>O</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>với</span> <span class=n>bảng</span> <span class=nb>hash</span> <span class=n>AVC</span>                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>PATHNAME</span><span class=o>-</span><span class=n>BASED</span> <span class=p>(</span><span class=n>AppArmor</span><span class=p>)</span>                                   <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Mô</span> <span class=n>hình</span><span class=p>:</span> <span class=n>Luật</span> <span class=n>dựa</span> <span class=n>trên</span> <span class=err>đườ</span><span class=n>ng</span> <span class=n>dẫn</span> <span class=n>file</span>                       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Profile</span><span class=p>:</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>sbin</span><span class=o>/</span><span class=n>httpd</span>                                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>┌─────────────────────────────────────────┐</span>               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/**</span> <span class=n>r</span><span class=p>,</span>                          <span class=err>│</span> <span class=c1># đọc web     │</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=nb>log</span><span class=o>/</span><span class=n>httpd</span><span class=o>/**</span> <span class=n>w</span><span class=p>,</span>                    <span class=err>│</span> <span class=c1># ghi log     │</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>httpd</span><span class=o>/</span><span class=n>conf</span><span class=o>/**</span> <span class=n>r</span><span class=p>,</span>                   <span class=err>│</span> <span class=c1># đọc config  │</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span> <span class=n>network</span> <span class=n>inet</span> <span class=n>stream</span><span class=p>,</span>                    <span class=err>│</span> <span class=c1># TCP socket  │</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└─────────────────────────────────────────┘</span>               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Thuật</span> <span class=n>toán</span> <span class=n>kiểm</span> <span class=n>tra</span><span class=p>:</span>                                        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>1.</span> <span class=n>Lấy</span> <span class=err>đườ</span><span class=n>ng</span> <span class=n>dẫn</span> <span class=n>file</span><span class=p>:</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>index</span><span class=o>.</span><span class=n>html</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>2.</span> <span class=n>So</span> <span class=n>khớp</span> <span class=n>với</span> <span class=n>pattern</span><span class=p>:</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/**</span>                       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>3.</span> <span class=n>Kiểm</span> <span class=n>tra</span> <span class=n>quyền</span><span class=p>:</span> <span class=n>r</span> <span class=p>(</span><span class=err>đọ</span><span class=n>c</span><span class=p>)</span>                                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>4.</span> <span class=n>Trả</span> <span class=n>về</span><span class=p>:</span> <span class=n>CHO</span> <span class=n>PHÉP</span>                                       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=err>Độ</span> <span class=n>phức</span> <span class=n>tạp</span><span class=p>:</span> <span class=n>O</span><span class=p>(</span><span class=err>độ</span><span class=n>_dài_đường_dẫn</span><span class=p>)</span> <span class=n>với</span> <span class=n>DFA</span><span class=o>/</span><span class=n>trie</span>               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>MLS</span> <span class=o>-</span> <span class=n>Multi</span><span class=o>-</span><span class=n>Level</span> <span class=n>Security</span> <span class=p>(</span><span class=n>Bell</span><span class=o>-</span><span class=n>LaPadula</span><span class=p>)</span>                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Mô</span> <span class=n>hình</span><span class=p>:</span> <span class=n>Mức</span> <span class=err>độ</span> <span class=n>bảo</span> <span class=n>mật</span> <span class=n>phân</span> <span class=n>cấp</span> <span class=p>(</span><span class=n>quân</span> <span class=n>sự</span><span class=o>/</span><span class=n>chính</span> <span class=n>phủ</span><span class=p>)</span>        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Tối</span> <span class=n>mật</span> <span class=err>────┐</span>                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Mật</span>     <span class=err>────┼──</span> <span class=n>Mức</span> <span class=n>bảo</span> <span class=n>mật</span> <span class=p>(</span><span class=n>sensitivity</span><span class=p>)</span>                 <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Hạn</span> <span class=n>chế</span> <span class=err>────┤</span>                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Không</span> <span class=n>mật</span> <span class=err>──┘</span>                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Quy</span> <span class=n>tắc</span><span class=p>:</span>                                                    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Không</span> <span class=err>đọ</span><span class=n>c</span> <span class=n>lên</span> <span class=p>(</span><span class=n>No</span> <span class=n>Read</span> <span class=n>Up</span><span class=p>)</span>                              <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>     <span class=n>Subject</span> <span class=s2>&#34;Mật&#34;</span> <span class=n>không</span> <span class=err>đọ</span><span class=n>c</span> <span class=err>đượ</span><span class=n>c</span> <span class=n>file</span> <span class=s2>&#34;Tối mật&#34;</span>             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>     <span class=err>→</span> <span class=n>Ngăn</span> <span class=n>rò</span> <span class=n>rỉ</span> <span class=n>thông</span> <span class=n>tin</span> <span class=n>lên</span> <span class=n>trên</span>                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Không</span> <span class=n>ghi</span> <span class=n>xuống</span> <span class=p>(</span><span class=n>No</span> <span class=n>Write</span> <span class=n>Down</span><span class=p>)</span>                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>     <span class=n>Subject</span> <span class=s2>&#34;Tối mật&#34;</span> <span class=n>không</span> <span class=n>ghi</span> <span class=err>đượ</span><span class=n>c</span> <span class=n>file</span> <span class=s2>&#34;Mật&#34;</span>             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>     <span class=err>→</span> <span class=n>Ngăn</span> <span class=n>nhiễm</span> <span class=n>bẩn</span> <span class=n>thông</span> <span class=n>tin</span> <span class=n>xuống</span> <span class=n>dưới</span>                   <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>SELinux</span> <span class=n>hỗ</span> <span class=n>trợ</span> <span class=n>MLS</span><span class=p>,</span> <span class=n>AppArmor</span> <span class=n>không</span> <span class=n>hỗ</span> <span class=n>trợ</span>                   <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span></span></span></code></pre></div><h3 class=heading-element id=13-linux-security-modules-lsm><span>1.3 Linux Security Modules (LSM)</span>
<a href=#13-linux-security-modules-lsm class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                    LSM FRAMEWORK                            │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Định nghĩa: Framework kernel cho phép cắm các module bảo mật
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>│   Ứng dụng                                                  │
</span></span><span class=line><span class=cl>│       │                                                     │
</span></span><span class=line><span class=cl>│       ▼ system call                                         │
</span></span><span class=line><span class=cl>│   ┌───────────────────────────────────────┐                 │
</span></span><span class=line><span class=cl>│   │              KERNEL                   │                 │
</span></span><span class=line><span class=cl>│   │                                       │                 │
</span></span><span class=line><span class=cl>│   │   ┌─────────────────────────────┐     │                 │
</span></span><span class=line><span class=cl>│   │   │    Kiểm tra DAC thông thường│     │                 │
</span></span><span class=line><span class=cl>│   │   └─────────────┬───────────────┘     │                 │
</span></span><span class=line><span class=cl>│   │                 │                     │                 │
</span></span><span class=line><span class=cl>│   │                 ▼                     │                 │
</span></span><span class=line><span class=cl>│   │   ┌─────────────────────────────┐     │                 │
</span></span><span class=line><span class=cl>│   │   │       LSM Hooks             │     │                 │
</span></span><span class=line><span class=cl>│   │   │  (điểm chèn bảo mật)        │     │                 │
</span></span><span class=line><span class=cl>│   │   └─────────────┬───────────────┘     │                 │
</span></span><span class=line><span class=cl>│   │                 │                     │                 │
</span></span><span class=line><span class=cl>│   │    ┌────────────┼────────────┐        │                 │
</span></span><span class=line><span class=cl>│   │    ▼            ▼            ▼        │                 │
</span></span><span class=line><span class=cl>│   │ ┌───────┐   ┌─────────┐  ┌───────┐    │                 │
</span></span><span class=line><span class=cl>│   │ │SELinux│   │AppArmor │  │ Smack │    │                 │
</span></span><span class=line><span class=cl>│   │ └───────┘   └─────────┘  └───────┘    │                 │
</span></span><span class=line><span class=cl>│   │                                       │                 │
</span></span><span class=line><span class=cl>│   └───────────────────────────────────────┘                 │
</span></span><span class=line><span class=cl>│                                                             │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>CÁC LSM CÓ SẴN:
</span></span><span class=line><span class=cl>┌───────────┬─────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│ Module    │ Mô tả                                           │
</span></span><span class=line><span class=cl>├───────────┼─────────────────────────────────────────────────┤
</span></span><span class=line><span class=cl>│ SELinux   │ Type Enforcement, MLS, RBAC đầy đủ              │
</span></span><span class=line><span class=cl>│ AppArmor  │ Pathname-based, đơn giản hơn                    │
</span></span><span class=line><span class=cl>│ Smack     │ MAC đơn giản cho thiết bị nhúng                 │
</span></span><span class=line><span class=cl>│ TOMOYO    │ Pathname-based, learning mode                   │
</span></span><span class=line><span class=cl>│ Yama      │ Hạn chế ptrace                                  │
</span></span><span class=line><span class=cl>│ LoadPin   │ Đảm bảo kernel modules từ cùng filesystem       │
</span></span><span class=line><span class=cl>│ Landlock  │ Sandbox không cần root                          │
</span></span><span class=line><span class=cl>└───────────┴─────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>STACKING (Xếp chồng - Linux 5.1+):
</span></span><span class=line><span class=cl>- Có thể chạy nhiều LSM cùng lúc
</span></span><span class=line><span class=cl>- Major LSM (SELinux HOẶC AppArmor) + Minor LSMs (Yama, LoadPin...)
</span></span><span class=line><span class=cl>- Kiểm tra LSM đang chạy:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat /sys/kernel/security/lsm
</span></span><span class=line><span class=cl># lockdown,capability,landlock,yama,apparmor</span></span></code></pre></div><hr><h2 class=heading-element id=phần-2-kiến-trúc-selinux><span>PHẦN 2: KIẾN TRÚC SELINUX</span>
<a href=#ph%e1%ba%a7n-2-ki%e1%ba%bfn-tr%c3%bac-selinux class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=21-thành-phần-cốt-lõi><span>2.1 Thành phần cốt lõi</span>
<a href=#21-th%c3%a0nh-ph%e1%ba%a7n-c%e1%bb%91t-l%c3%b5i class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>              <span class=n>CÁC</span> <span class=n>THÀNH</span> <span class=n>PHẦN</span> <span class=n>SELINUX</span>                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=mf>1.</span> <span class=n>POLICY</span> <span class=n>DATABASE</span> <span class=p>(</span><span class=n>Cơ</span> <span class=n>sở</span> <span class=n>dữ</span> <span class=n>liệu</span> <span class=n>chính</span> <span class=n>sách</span><span class=p>)</span>               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Vị</span> <span class=n>trí</span><span class=p>:</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>selinux</span><span class=o>/</span><span class=n>targeted</span><span class=o>/</span><span class=n>policy</span><span class=o>/</span><span class=n>policy</span><span class=o>.</span><span class=n>XX</span>            <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Chứa</span><span class=p>:</span>                                                     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Tất</span> <span class=n>cả</span> <span class=n>luật</span> <span class=n>allow</span><span class=o>/</span><span class=n>deny</span>                                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=err>Đị</span><span class=n>nh</span> <span class=n>nghĩa</span> <span class=n>type</span>                                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=err>Á</span><span class=n>nh</span> <span class=n>xạ</span> <span class=n>role</span>                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Ràng</span> <span class=n>buộc</span> <span class=n>MLS</span>                                           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>Đị</span><span class=n>nh</span> <span class=n>dạng</span><span class=p>:</span> <span class=n>Nhị</span> <span class=n>phân</span> <span class=n>biên</span> <span class=n>dịch</span> <span class=p>(</span><span class=n>không</span> <span class=err>đọ</span><span class=n>c</span> <span class=n>trực</span> <span class=n>tiếp</span> <span class=err>đượ</span><span class=n>c</span><span class=p>)</span>  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=mf>2.</span> <span class=n>AVC</span> <span class=o>-</span> <span class=n>Access</span> <span class=n>Vector</span> <span class=n>Cache</span>                                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Chức</span> <span class=n>năng</span><span class=p>:</span> <span class=n>Bộ</span> <span class=n>nhớ</span> <span class=err>đệ</span><span class=n>m</span> <span class=n>quyết</span> <span class=err>đị</span><span class=n>nh</span> <span class=n>truy</span> <span class=n>cập</span>                 <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Cấu</span> <span class=n>trúc</span><span class=p>:</span> <span class=n>Bảng</span> <span class=nb>hash</span>                                       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Khóa</span><span class=p>:</span> <span class=p>(</span><span class=n>source_type</span><span class=p>,</span> <span class=n>target_type</span><span class=p>,</span> <span class=n>object_class</span><span class=p>)</span>            <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Giá</span> <span class=n>trị</span><span class=p>:</span> <span class=n>Bitmap</span> <span class=n>quyền</span> <span class=p>{</span><span class=n>read</span><span class=p>,</span> <span class=n>write</span><span class=p>,</span> <span class=n>execute</span><span class=p>,</span> <span class=o>...</span><span class=p>}</span>         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Hiệu</span> <span class=n>năng</span><span class=p>:</span>                                                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Cache</span> <span class=n>hit</span><span class=p>:</span> <span class=n>O</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>tra</span> <span class=n>cứu</span>                                 <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Cache</span> <span class=n>miss</span><span class=p>:</span> <span class=n>Tra</span> <span class=n>policy</span><span class=p>,</span> <span class=n>O</span><span class=p>(</span><span class=nb>log</span> <span class=n>n</span><span class=p>)</span> <span class=n>hoặc</span> <span class=n>O</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=n>với</span> <span class=nb>hash</span>     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Xem</span> <span class=n>thống</span> <span class=n>kê</span><span class=p>:</span>                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>cat</span> <span class=o>/</span><span class=n>sys</span><span class=o>/</span><span class=n>fs</span><span class=o>/</span><span class=n>selinux</span><span class=o>/</span><span class=n>avc</span><span class=o>/</span><span class=n>cache_stats</span>                       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=mf>3.</span> <span class=n>SID</span> <span class=n>TABLE</span> <span class=p>(</span><span class=n>Bảng</span> <span class=n>Security</span> <span class=n>Identifier</span><span class=p>)</span>                     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Chức</span> <span class=n>năng</span><span class=p>:</span> <span class=err>Á</span><span class=n>nh</span> <span class=n>xạ</span> <span class=n>context</span> <span class=n>string</span> <span class=err>→</span> <span class=n>SID</span> <span class=n>số</span>                 <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=s2>&#34;system_u:system_r:httpd_t:s0&#34;</span> <span class=err>→</span> <span class=n>SID</span> <span class=mi>1234</span>                 <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Kernel</span> <span class=n>dùng</span> <span class=n>SID</span> <span class=n>số</span> <span class=n>cho</span> <span class=n>hiệu</span> <span class=n>quả</span><span class=p>,</span> <span class=n>không</span> <span class=n>so</span> <span class=n>sánh</span> <span class=n>chuỗi</span>      <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=mf>4.</span> <span class=n>OBJECT</span> <span class=n>MANAGERS</span> <span class=p>(</span><span class=n>Trình</span> <span class=n>quản</span> <span class=n>lý</span> <span class=err>đố</span><span class=n>i</span> <span class=n>tượng</span><span class=p>)</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Mỗi</span> <span class=n>loại</span> <span class=n>object</span> <span class=n>có</span> <span class=n>manager</span> <span class=n>riêng</span><span class=p>:</span>                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=ne>File</span> <span class=n>manager</span><span class=p>:</span> <span class=n>file</span><span class=p>,</span> <span class=n>dir</span><span class=p>,</span> <span class=n>socket</span><span class=p>,</span> <span class=n>pipe</span><span class=p>,</span> <span class=o>...</span>              <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Process</span> <span class=n>manager</span><span class=p>:</span> <span class=n>fork</span><span class=p>,</span> <span class=n>transition</span><span class=p>,</span> <span class=k>signal</span><span class=p>,</span> <span class=o>...</span>          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Network</span> <span class=n>manager</span><span class=p>:</span> <span class=n>tcp_socket</span><span class=p>,</span> <span class=n>udp_socket</span><span class=p>,</span> <span class=n>netif</span><span class=p>,</span> <span class=o>...</span>     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>IPC</span> <span class=n>manager</span><span class=p>:</span> <span class=n>shm</span><span class=p>,</span> <span class=n>sem</span><span class=p>,</span> <span class=n>msg</span><span class=p>,</span> <span class=o>...</span>                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Manager</span> <span class=n>thực</span> <span class=n>thi</span> <span class=n>policy</span> <span class=n>cho</span> <span class=n>loại</span> <span class=n>object</span> <span class=n>tương</span> <span class=err>ứ</span><span class=n>ng</span>         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span></span></span></code></pre></div><h3 class=heading-element id=22-security-context><span>2.2 Security Context</span>
<a href=#22-security-context class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>              <span class=n>SECURITY</span> <span class=n>CONTEXT</span> <span class=p>(</span><span class=n>NHÃN</span> <span class=n>BẢO</span> <span class=n>MẬT</span><span class=p>)</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>Đị</span><span class=n>nh</span> <span class=n>dạng</span><span class=p>:</span> <span class=n>user</span><span class=p>:</span><span class=n>role</span><span class=p>:</span><span class=n>type</span><span class=p>:</span><span class=n>level</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>system_u</span> <span class=p>:</span> <span class=n>system_r</span> <span class=p>:</span> <span class=n>httpd_t</span> <span class=p>:</span> <span class=n>s0</span>                        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>│</span>          <span class=err>│</span>       <span class=err>│</span>                        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>│</span>          <span class=err>│</span>       <span class=err>└─</span> <span class=n>MLS</span> <span class=n>level</span> <span class=p>(</span><span class=n>tùy</span> <span class=n>chọn</span><span class=p>)</span>  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>│</span>          <span class=err>│</span>          <span class=n>s0</span> <span class=o>=</span> <span class=n>thấp</span> <span class=n>nhất</span>        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>│</span>          <span class=err>│</span>          <span class=n>s0</span><span class=o>-</span><span class=n>s15</span> <span class=o>=</span> <span class=n>dải</span>          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>│</span>          <span class=err>│</span>                                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>│</span>          <span class=err>└─</span> <span class=n>TYPE</span> <span class=p>(</span><span class=n>QUAN</span> <span class=n>TRỌNG</span> <span class=n>NHẤT</span><span class=o>!</span><span class=p>)</span>       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>│</span>             <span class=n>Quyết</span> <span class=err>đị</span><span class=n>nh</span> <span class=n>những</span> <span class=n>gì</span> <span class=err>đượ</span><span class=n>c</span> <span class=n>phép</span> <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>│</span>             <span class=n>httpd_t</span> <span class=o>=</span> <span class=n>domain</span> <span class=n>web</span> <span class=n>server</span>   <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>│</span>                                           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>          <span class=err>└─</span> <span class=n>ROLE</span>                                     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>             <span class=n>Nhóm</span> <span class=n>các</span> <span class=n>type</span> <span class=err>đượ</span><span class=n>c</span> <span class=n>phép</span>                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>             <span class=n>system_r</span> <span class=o>=</span> <span class=n>role</span> <span class=n>hệ</span> <span class=n>thống</span>                 <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>             <span class=n>user_r</span> <span class=o>=</span> <span class=n>role</span> <span class=n>người</span> <span class=n>dùng</span>                 <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>│</span>                                                      <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>└─</span> <span class=n>USER</span>                                                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>         <span class=n>Danh</span> <span class=n>tính</span> <span class=n>SELinux</span> <span class=p>(</span><span class=n>không</span> <span class=n>phải</span> <span class=n>Linux</span> <span class=n>user</span><span class=o>!</span><span class=p>)</span>          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>         <span class=n>system_u</span> <span class=o>=</span> <span class=n>user</span> <span class=n>hệ</span> <span class=n>thống</span>                            <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>         <span class=n>unconfined_u</span> <span class=o>=</span> <span class=n>user</span> <span class=n>không</span> <span class=n>bị</span> <span class=n>giới</span> <span class=n>hạn</span>               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>XEM</span> <span class=n>CONTEXT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Context của processes</span>
</span></span><span class=line><span class=cl><span class=n>ps</span> <span class=n>auxZ</span>
</span></span><span class=line><span class=cl><span class=c1># LABEL                           USER  PID  COMMAND</span>
</span></span><span class=line><span class=cl><span class=c1># system_u:system_r:httpd_t:s0    root  1234 /usr/sbin/httpd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Context của files</span>
</span></span><span class=line><span class=cl><span class=n>ls</span> <span class=o>-</span><span class=n>Z</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>html</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=c1># system_u:object_r:httpd_sys_content_t:s0 index.html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Context của user hiện tại</span>
</span></span><span class=line><span class=cl><span class=n>id</span> <span class=o>-</span><span class=n>Z</span>
</span></span><span class=line><span class=cl><span class=c1># unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Context của process hiện tại</span>
</span></span><span class=line><span class=cl><span class=n>cat</span> <span class=o>/</span><span class=n>proc</span><span class=o>/</span><span class=bp>self</span><span class=o>/</span><span class=n>attr</span><span class=o>/</span><span class=n>current</span>
</span></span><span class=line><span class=cl><span class=c1># unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span></span></span></code></pre></div><h3 class=heading-element id=23-type-enforcement><span>2.3 Type Enforcement</span>
<a href=#23-type-enforcement class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>              <span class=n>TYPE</span> <span class=n>ENFORCEMENT</span>                               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Cốt</span> <span class=n>lõi</span> <span class=n>của</span> <span class=n>SELinux</span><span class=p>:</span> <span class=n>Luật</span> <span class=n>dựa</span> <span class=n>trên</span> <span class=n>TYPE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CÚ</span> <span class=n>PHÁP</span> <span class=n>LUẬT</span> <span class=n>ALLOW</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>allow</span> <span class=n>source_type</span> <span class=n>target_type</span> <span class=p>:</span> <span class=n>object_class</span> <span class=n>permissions</span><span class=p>;</span> <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Ví</span> <span class=n>dụ</span><span class=p>:</span>                                                    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>allow</span> <span class=n>httpd_t</span> <span class=n>httpd_sys_content_t</span> <span class=p>:</span> <span class=n>file</span> <span class=p>{</span> <span class=n>read</span> <span class=n>open</span> <span class=p>};</span>   <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>         <span class=err>└──┬──┘</span> <span class=err>└───────┬─────────┘</span>   <span class=err>└┬─┘</span>  <span class=err>└────┬─────┘</span>    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>            <span class=err>│</span>            <span class=err>│</span>              <span class=err>│</span>         <span class=err>│</span>          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>     <span class=n>Domain</span> <span class=n>của</span>     <span class=n>Type</span> <span class=n>của</span> <span class=n>file</span>   <span class=n>Loại</span> <span class=err>đố</span><span class=n>i</span>   <span class=n>Quyền</span> <span class=n>cho</span>     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>     <span class=n>process</span>        <span class=err>đượ</span><span class=n>c</span> <span class=n>truy</span> <span class=n>cập</span>   <span class=n>tượng</span>      <span class=n>phép</span>          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>     <span class=p>(</span><span class=n>web</span> <span class=n>server</span><span class=p>)</span>   <span class=p>(</span><span class=n>nội</span> <span class=n>dung</span> <span class=n>web</span><span class=p>)</span>  <span class=p>(</span><span class=n>file</span><span class=p>)</span>     <span class=p>(</span><span class=err>đọ</span><span class=n>c</span><span class=p>,</span> <span class=n>mở</span><span class=p>)</span>     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>OBJECT</span> <span class=n>CLASSES</span> <span class=n>PHỔ</span> <span class=n>BIẾN</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>┌───────────────┬─────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Class</span>         <span class=err>│</span> <span class=n>Mô</span> <span class=n>tả</span>                                       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├───────────────┼─────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>file</span>          <span class=err>│</span> <span class=ne>File</span> <span class=n>thông</span> <span class=n>thường</span>                           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>dir</span>           <span class=err>│</span> <span class=n>Thư</span> <span class=n>mục</span>                                     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>lnk_file</span>      <span class=err>│</span> <span class=n>Symbolic</span> <span class=n>link</span>                               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>sock_file</span>     <span class=err>│</span> <span class=n>Unix</span> <span class=n>domain</span> <span class=n>socket</span>                          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>fifo_file</span>     <span class=err>│</span> <span class=n>Named</span> <span class=n>pipe</span>                                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>chr_file</span>      <span class=err>│</span> <span class=n>Character</span> <span class=n>device</span>                            <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>blk_file</span>      <span class=err>│</span> <span class=n>Block</span> <span class=n>device</span>                                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>process</span>       <span class=err>│</span> <span class=n>Process</span>                                     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>tcp_socket</span>    <span class=err>│</span> <span class=n>TCP</span> <span class=n>socket</span>                                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>udp_socket</span>    <span class=err>│</span> <span class=n>UDP</span> <span class=n>socket</span>                                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>netif</span>         <span class=err>│</span> <span class=n>Network</span> <span class=n>interface</span>                           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>node</span>          <span class=err>│</span> <span class=n>Network</span> <span class=n>node</span> <span class=p>(</span><span class=ne>IP</span><span class=p>)</span>                           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>port</span>          <span class=err>│</span> <span class=n>Network</span> <span class=n>port</span>                                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└───────────────┴─────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PERMISSIONS</span> <span class=n>PHỔ</span> <span class=n>BIẾN</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>┌───────────────┬─────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Class</span><span class=p>:</span> <span class=n>file</span>   <span class=err>│</span> <span class=n>read</span> <span class=n>write</span> <span class=n>execute</span> <span class=n>append</span> <span class=n>create</span> <span class=n>unlink</span> <span class=o>...</span> <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Class</span><span class=p>:</span> <span class=n>dir</span>    <span class=err>│</span> <span class=n>search</span> <span class=n>add_name</span> <span class=n>remove_name</span> <span class=n>read</span> <span class=n>write</span> <span class=o>...</span>  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Class</span><span class=p>:</span> <span class=n>process</span><span class=err>│</span> <span class=n>fork</span> <span class=n>transition</span> <span class=k>signal</span> <span class=n>ptrace</span> <span class=o>...</span>           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Class</span><span class=p>:</span> <span class=n>tcp_socket</span> <span class=err>│</span> <span class=n>connect</span> <span class=n>bind</span> <span class=n>listen</span> <span class=n>accept</span> <span class=o>...</span>          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└───────────────┴─────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TYPE</span> <span class=n>TRANSITION</span> <span class=p>(</span><span class=n>Chuyển</span> <span class=err>đổ</span><span class=n>i</span> <span class=n>type</span><span class=p>):</span>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>  <span class=c1># Khi httpd_t tạo file trong thư mục httpd_log_t           │</span>
</span></span><span class=line><span class=cl><span class=err>│</span>  <span class=c1># File mới sẽ có type httpd_log_t                          │</span>
</span></span><span class=line><span class=cl><span class=err>│</span>  <span class=n>type_transition</span> <span class=n>httpd_t</span> <span class=n>httpd_log_t</span> <span class=p>:</span> <span class=n>file</span> <span class=n>httpd_log_t</span><span class=p>;</span>    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>  <span class=c1># Khi init chạy httpd_exec_t, process mới có domain httpd_t│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>type_transition</span> <span class=n>init_t</span> <span class=n>httpd_exec_t</span> <span class=p>:</span> <span class=n>process</span> <span class=n>httpd_t</span><span class=p>;</span>    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span></span></span></code></pre></div><h3 class=heading-element id=24-file-context-database><span>2.4 File Context Database</span>
<a href=#24-file-context-database class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># CƠ SỞ DỮ LIỆU FILE CONTEXT</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vị trí: /etc/selinux/targeted/contexts/files/file_contexts</span>
</span></span><span class=line><span class=cl><span class=c1># Định dạng: regex context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xem database</span>
</span></span><span class=line><span class=cl>cat /etc/selinux/targeted/contexts/files/file_contexts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ví dụ nội dung:</span>
</span></span><span class=line><span class=cl><span class=c1># /var/www(/.*)?              system_u:object_r:httpd_sys_content_t:s0</span>
</span></span><span class=line><span class=cl><span class=c1># /var/log/httpd(/.*)?        system_u:object_r:httpd_log_t:s0</span>
</span></span><span class=line><span class=cl><span class=c1># /etc/httpd(/.*)?            system_u:object_r:httpd_config_t:s0</span>
</span></span><span class=line><span class=cl><span class=c1># /usr/sbin/httpd             system_u:object_r:httpd_exec_t:s0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># LỆNH GÁN NHÃN</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># chcon - Thay đổi context tạm thời (mất khi relabel)</span>
</span></span><span class=line><span class=cl>chcon -t httpd_sys_content_t /path/to/file
</span></span><span class=line><span class=cl>chcon -R -t httpd_sys_content_t /path/to/dir/   <span class=c1># Đệ quy</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># restorecon - Khôi phục context theo database</span>
</span></span><span class=line><span class=cl>restorecon /path/to/file
</span></span><span class=line><span class=cl>restorecon -R /path/to/dir/                      <span class=c1># Đệ quy</span>
</span></span><span class=line><span class=cl>restorecon -Rv /path/to/dir/                     <span class=c1># Chi tiết</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># semanage fcontext - Thêm luật vĩnh viễn vào database</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t httpd_sys_content_t <span class=s2>&#34;/web(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>restorecon -Rv /web
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liệt kê luật tùy chỉnh</span>
</span></span><span class=line><span class=cl>semanage fcontext -l -C
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xóa luật tùy chỉnh</span>
</span></span><span class=line><span class=cl>semanage fcontext -d <span class=s2>&#34;/web(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># matchpathcon - Kiểm tra context mong đợi</span>
</span></span><span class=line><span class=cl>matchpathcon /var/www/html/index.html
</span></span><span class=line><span class=cl><span class=c1># /var/www/html/index.html    system_u:object_r:httpd_sys_content_t:s0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># CÁC TYPE PHỔ BIẾN</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Web server (Apache/Nginx)</span>
</span></span><span class=line><span class=cl>httpd_sys_content_t      <span class=c1># Nội dung web chỉ đọc</span>
</span></span><span class=line><span class=cl>httpd_sys_rw_content_t   <span class=c1># Nội dung web đọc/ghi</span>
</span></span><span class=line><span class=cl>httpd_log_t              <span class=c1># Log files</span>
</span></span><span class=line><span class=cl>httpd_config_t           <span class=c1># Cấu hình</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Database (MySQL/PostgreSQL)</span>
</span></span><span class=line><span class=cl>mysqld_db_t              <span class=c1># Data files MySQL</span>
</span></span><span class=line><span class=cl>postgresql_db_t          <span class=c1># Data files PostgreSQL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># User</span>
</span></span><span class=line><span class=cl>user_home_t              <span class=c1># Home directory</span>
</span></span><span class=line><span class=cl>user_home_dir_t          <span class=c1># Home directory root</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Hệ thống</span>
</span></span><span class=line><span class=cl>etc_t                    <span class=c1># /etc files</span>
</span></span><span class=line><span class=cl>var_log_t                <span class=c1># Log files chung</span>
</span></span><span class=line><span class=cl>tmp_t                    <span class=c1># /tmp files</span>
</span></span><span class=line><span class=cl>bin_t                    <span class=c1># /bin executables</span></span></span></code></pre></div><hr><h2 class=heading-element id=phần-3-vận-hành-selinux><span>PHẦN 3: VẬN HÀNH SELINUX</span>
<a href=#ph%e1%ba%a7n-3-v%e1%ba%adn-h%c3%a0nh-selinux class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=31-chế-độ-selinux><span>3.1 Chế độ SELinux</span>
<a href=#31-ch%e1%ba%bf-%c4%91%e1%bb%99-selinux class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># CÁC CHẾ ĐỘ SELINUX</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Enforcing: Thực thi policy, chặn vi phạm</span>
</span></span><span class=line><span class=cl><span class=c1># Permissive: Chỉ ghi log, không chặn</span>
</span></span><span class=line><span class=cl><span class=c1># Disabled: Tắt hoàn toàn (cần reboot để bật lại)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># KIỂM TRA TRẠNG THÁI</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chế độ hiện tại</span>
</span></span><span class=line><span class=cl>getenforce
</span></span><span class=line><span class=cl><span class=c1># Enforcing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Thông tin chi tiết</span>
</span></span><span class=line><span class=cl>sestatus
</span></span><span class=line><span class=cl><span class=c1># SELinux status:                 enabled</span>
</span></span><span class=line><span class=cl><span class=c1># SELinuxfs mount:                /sys/fs/selinux</span>
</span></span><span class=line><span class=cl><span class=c1># SELinux root directory:         /etc/selinux</span>
</span></span><span class=line><span class=cl><span class=c1># Loaded policy name:             targeted</span>
</span></span><span class=line><span class=cl><span class=c1># Current mode:                   enforcing</span>
</span></span><span class=line><span class=cl><span class=c1># Mode from config file:          enforcing</span>
</span></span><span class=line><span class=cl><span class=c1># Policy MLS status:              enabled</span>
</span></span><span class=line><span class=cl><span class=c1># Policy deny_unknown status:     allowed</span>
</span></span><span class=line><span class=cl><span class=c1># Max kernel policy version:      33</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># THAY ĐỔI CHẾ ĐỘ</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tạm thời (mất khi reboot)</span>
</span></span><span class=line><span class=cl>setenforce <span class=m>0</span>     <span class=c1># Permissive</span>
</span></span><span class=line><span class=cl>setenforce <span class=m>1</span>     <span class=c1># Enforcing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vĩnh viễn: sửa /etc/selinux/config</span>
</span></span><span class=line><span class=cl><span class=c1># SELINUX=enforcing</span>
</span></span><span class=line><span class=cl><span class=c1># SELINUX=permissive</span>
</span></span><span class=line><span class=cl><span class=c1># SELINUX=disabled</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CẢNH BÁO: Từ disabled sang enabled cần:</span>
</span></span><span class=line><span class=cl><span class=c1># 1. Sửa config</span>
</span></span><span class=line><span class=cl><span class=c1># 2. touch /.autorelabel</span>
</span></span><span class=line><span class=cl><span class=c1># 3. Reboot (sẽ relabel toàn bộ filesystem, mất thời gian!)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># PERMISSIVE PER-DOMAIN (Permissive từng domain)</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chỉ permissive cho một domain (debug mà không ảnh hưởng hệ thống)</span>
</span></span><span class=line><span class=cl>semanage permissive -a httpd_t
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liệt kê domain đang permissive</span>
</span></span><span class=line><span class=cl>semanage permissive -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xóa permissive</span>
</span></span><span class=line><span class=cl>semanage permissive -d httpd_t</span></span></code></pre></div><h3 class=heading-element id=32-policy-types><span>3.2 Policy Types</span>
<a href=#32-policy-types class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># CÁC LOẠI POLICY</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># targeted: Mặc định, chỉ giới hạn daemon/service</span>
</span></span><span class=line><span class=cl><span class=c1>#           Hầu hết user processes chạy unconfined</span>
</span></span><span class=line><span class=cl><span class=c1>#           Phù hợp cho server thông thường</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># minimum:  Tập con của targeted</span>
</span></span><span class=line><span class=cl><span class=c1>#           Chỉ các service được chọn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># mls:      Multi-Level Security đầy đủ</span>
</span></span><span class=line><span class=cl><span class=c1>#           Cho môi trường quân sự/chính phủ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xem policy đang dùng</span>
</span></span><span class=line><span class=cl>sestatus <span class=p>|</span> grep <span class=s2>&#34;Loaded policy&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Loaded policy name:             targeted</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Thay đổi: sửa /etc/selinux/config</span>
</span></span><span class=line><span class=cl><span class=c1># SELINUXTYPE=targeted</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># QUẢN LÝ POLICY MODULES</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liệt kê modules đã cài</span>
</span></span><span class=line><span class=cl>semodule -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cài đặt module</span>
</span></span><span class=line><span class=cl>semodule -i mymodule.pp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Gỡ module</span>
</span></span><span class=line><span class=cl>semodule -r mymodule
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vô hiệu hóa module (không xóa)</span>
</span></span><span class=line><span class=cl>semodule -d httpd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kích hoạt lại</span>
</span></span><span class=line><span class=cl>semodule -e httpd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Rebuild policy</span>
</span></span><span class=line><span class=cl>semodule -B</span></span></code></pre></div><h3 class=heading-element id=33-booleans><span>3.3 Booleans</span>
<a href=#33-booleans class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BOOLEANS - Công tắc bật/tắt tính năng policy</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liệt kê tất cả booleans</span>
</span></span><span class=line><span class=cl>getsebool -a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tìm boolean liên quan</span>
</span></span><span class=line><span class=cl>getsebool -a <span class=p>|</span> grep httpd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xem giá trị một boolean</span>
</span></span><span class=line><span class=cl>getsebool httpd_can_network_connect
</span></span><span class=line><span class=cl><span class=c1># httpd_can_network_connect --&gt; off</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Thay đổi tạm thời (mất khi reboot)</span>
</span></span><span class=line><span class=cl>setsebool httpd_can_network_connect on
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Thay đổi vĩnh viễn</span>
</span></span><span class=line><span class=cl>setsebool -P httpd_can_network_connect on
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xem với mô tả</span>
</span></span><span class=line><span class=cl>semanage boolean -l <span class=p>|</span> grep httpd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liệt kê booleans đã thay đổi từ mặc định</span>
</span></span><span class=line><span class=cl>semanage boolean -l -C
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BOOLEANS PHỔ BIẾN</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Web server</span>
</span></span><span class=line><span class=cl>httpd_can_network_connect          <span class=c1># Kết nối mạng ra ngoài</span>
</span></span><span class=line><span class=cl>httpd_can_network_connect_db       <span class=c1># Kết nối database</span>
</span></span><span class=line><span class=cl>httpd_enable_cgi                   <span class=c1># Chạy CGI scripts</span>
</span></span><span class=line><span class=cl>httpd_enable_homedirs              <span class=c1># Truy cập ~/public_html</span>
</span></span><span class=line><span class=cl>httpd_read_user_content            <span class=c1># Đọc nội dung user</span>
</span></span><span class=line><span class=cl>httpd_use_nfs                      <span class=c1># Truy cập NFS mounts</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Samba</span>
</span></span><span class=line><span class=cl>samba_enable_home_dirs             <span class=c1># Chia sẻ home directories</span>
</span></span><span class=line><span class=cl>samba_export_all_ro                <span class=c1># Xuất tất cả chỉ đọc</span>
</span></span><span class=line><span class=cl>samba_export_all_rw                <span class=c1># Xuất tất cả đọc/ghi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># FTP</span>
</span></span><span class=line><span class=cl>ftpd_anon_write                    <span class=c1># Anonymous ghi được</span>
</span></span><span class=line><span class=cl>ftpd_full_access                   <span class=c1># Truy cập đầy đủ</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NFS</span>
</span></span><span class=line><span class=cl>nfs_export_all_ro                  <span class=c1># Xuất tất cả chỉ đọc</span>
</span></span><span class=line><span class=cl>nfs_export_all_rw                  <span class=c1># Xuất tất cả đọc/ghi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># General</span>
</span></span><span class=line><span class=cl>allow_execmem                      <span class=c1># Cho phép executable memory</span>
</span></span><span class=line><span class=cl>allow_execstack                    <span class=c1># Cho phép executable stack</span></span></span></code></pre></div><h3 class=heading-element id=34-port-context><span>3.4 Port Context</span>
<a href=#34-port-context class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># QUẢN LÝ PORT</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SELinux kiểm soát services bind vào port nào</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liệt kê tất cả port mappings</span>
</span></span><span class=line><span class=cl>semanage port -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tìm port cụ thể</span>
</span></span><span class=line><span class=cl>semanage port -l <span class=p>|</span> grep <span class=m>80</span>
</span></span><span class=line><span class=cl><span class=c1># http_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>semanage port -l <span class=p>|</span> grep ssh
</span></span><span class=line><span class=cl><span class=c1># ssh_port_t                     tcp      22</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Thêm port mới cho một type</span>
</span></span><span class=line><span class=cl>semanage port -a -t http_port_t -p tcp <span class=m>8080</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sửa port đã tồn tại</span>
</span></span><span class=line><span class=cl>semanage port -m -t http_port_t -p tcp <span class=m>8080</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xóa port tùy chỉnh</span>
</span></span><span class=line><span class=cl>semanage port -d -t http_port_t -p tcp <span class=m>8080</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liệt kê port tùy chỉnh</span>
</span></span><span class=line><span class=cl>semanage port -l -C
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VÍ DỤ: HTTPD CHẠY PORT KHÁC</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. Kiểm tra port hiện tại</span>
</span></span><span class=line><span class=cl>semanage port -l <span class=p>|</span> grep http_port_t
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. Thêm port 8888</span>
</span></span><span class=line><span class=cl>semanage port -a -t http_port_t -p tcp <span class=m>8888</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. Cấu hình httpd dùng port 8888</span>
</span></span><span class=line><span class=cl><span class=c1># Sửa /etc/httpd/conf/httpd.conf</span>
</span></span><span class=line><span class=cl><span class=c1># Listen 8888</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. Restart service</span>
</span></span><span class=line><span class=cl>systemctl restart httpd</span></span></code></pre></div><h3 class=heading-element id=35-user-mappings><span>3.5 User Mappings</span>
<a href=#35-user-mappings class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># SELINUX USERS</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SELinux users KHÁC với Linux users!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Các SELinux users chính:</span>
</span></span><span class=line><span class=cl><span class=c1># system_u    - Processes/files hệ thống</span>
</span></span><span class=line><span class=cl><span class=c1># unconfined_u - User không bị giới hạn</span>
</span></span><span class=line><span class=cl><span class=c1># user_u      - User thông thường (giới hạn)</span>
</span></span><span class=line><span class=cl><span class=c1># staff_u     - User có thể dùng sudo</span>
</span></span><span class=line><span class=cl><span class=c1># sysadm_u    - System admin</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># ÁNH XẠ LINUX USER → SELINUX USER</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xem ánh xạ hiện tại</span>
</span></span><span class=line><span class=cl>semanage login -l
</span></span><span class=line><span class=cl><span class=c1># Login Name    SELinux User   MLS/MCS Range    Service</span>
</span></span><span class=line><span class=cl><span class=c1># __default__   unconfined_u   s0-s0:c0.c1023   *</span>
</span></span><span class=line><span class=cl><span class=c1># root          unconfined_u   s0-s0:c0.c1023   *</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Thêm ánh xạ cho user</span>
</span></span><span class=line><span class=cl>semanage login -a -s user_u alice
</span></span><span class=line><span class=cl><span class=c1># alice sẽ chạy với user_u (bị giới hạn)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sửa ánh xạ</span>
</span></span><span class=line><span class=cl>semanage login -m -s staff_u alice
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xóa ánh xạ</span>
</span></span><span class=line><span class=cl>semanage login -d alice
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># SỰ KHÁC BIỆT GIỮA CÁC SELINUX USERS</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># unconfined_u: Không bị giới hạn, như không có SELinux</span>
</span></span><span class=line><span class=cl><span class=c1># user_u:       Không sudo, không su, không network access</span>
</span></span><span class=line><span class=cl><span class=c1># staff_u:      Có thể sudo sang sysadm_r</span>
</span></span><span class=line><span class=cl><span class=c1># sysadm_u:     Full system admin, vẫn bị giới hạn bởi policy</span></span></span></code></pre></div><hr><h2 class=heading-element id=phần-4-xử-lý-sự-cố-selinux><span>PHẦN 4: XỬ LÝ SỰ CỐ SELINUX</span>
<a href=#ph%e1%ba%a7n-4-x%e1%bb%ad-l%c3%bd-s%e1%bb%b1-c%e1%bb%91-selinux class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=41-tìm-avc-denials><span>4.1 Tìm AVC Denials</span>
<a href=#41-t%c3%acm-avc-denials class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># AVC DENIAL LÀ GÌ?</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># AVC = Access Vector Cache</span>
</span></span><span class=line><span class=cl><span class=c1># Denial = SELinux chặn một truy cập</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># TÌM DENIALS</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ausearch - Tìm trong audit log</span>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent              <span class=c1># Gần đây</span>
</span></span><span class=line><span class=cl>ausearch -m avc -ts today               <span class=c1># Hôm nay</span>
</span></span><span class=line><span class=cl>ausearch -m avc -ts <span class=s2>&#34;10 minutes ago&#34;</span>    <span class=c1># 10 phút trước</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># grep audit log</span>
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;avc:  denied&#34;</span> /var/log/audit/audit.log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Với ausearch chi tiết</span>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent --interpret
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># ĐỌC HIỂU DENIAL MESSAGE</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ví dụ:</span>
</span></span><span class=line><span class=cl><span class=c1># type=AVC msg=audit(1234567890.123:456): avc:  denied  { read }</span>
</span></span><span class=line><span class=cl><span class=c1># for  pid=1234 comm=&#34;httpd&#34; name=&#34;index.html&#34; dev=&#34;sda1&#34; ino=789</span>
</span></span><span class=line><span class=cl><span class=c1># scontext=system_u:system_r:httpd_t:s0</span>
</span></span><span class=line><span class=cl><span class=c1># tcontext=system_u:object_r:user_home_t:s0 tclass=file</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Phân tích:</span>
</span></span><span class=line><span class=cl><span class=c1># avc:  denied  { read }</span>
</span></span><span class=line><span class=cl><span class=c1>#       └─ Thao tác bị chặn: đọc</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># comm=&#34;httpd&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#       └─ Tên process</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># name=&#34;index.html&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#       └─ File bị truy cập</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># scontext=...httpd_t...</span>
</span></span><span class=line><span class=cl><span class=c1>#       └─ Source context (domain của process)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># tcontext=...user_home_t...</span>
</span></span><span class=line><span class=cl><span class=c1>#       └─ Target context (type của file)</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1># tclass=file</span>
</span></span><span class=line><span class=cl><span class=c1>#       └─ Loại object</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># NGHĨA: httpd_t cố đọc file có type user_home_t và bị chặn</span></span></span></code></pre></div><h3 class=heading-element id=42-công-cụ-phân-tích><span>4.2 Công cụ phân tích</span>
<a href=#42-c%c3%b4ng-c%e1%bb%a5-ph%c3%a2n-t%c3%adch class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># sealert - Phân tích denial dễ đọc</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cài đặt</span>
</span></span><span class=line><span class=cl>yum install setroubleshoot-server    <span class=c1># RHEL/CentOS</span>
</span></span><span class=line><span class=cl>dnf install setroubleshoot-server    <span class=c1># Fedora</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Phân tích tất cả alerts</span>
</span></span><span class=line><span class=cl>sealert -a /var/log/audit/audit.log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kết quả dễ đọc với đề xuất sửa!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># audit2why - Giải thích tại sao bị chặn</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Phân tích denial từ stdin</span>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent <span class=p>|</span> audit2why
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ví dụ output:</span>
</span></span><span class=line><span class=cl><span class=c1># type=AVC ... denied { read } ...</span>
</span></span><span class=line><span class=cl><span class=c1>#</span>
</span></span><span class=line><span class=cl><span class=c1>#         Đã tìm thấy giải thích:</span>
</span></span><span class=line><span class=cl><span class=c1>#         Nguyên nhân: httpd không được phép đọc user_home_t</span>
</span></span><span class=line><span class=cl><span class=c1>#         Để sửa: Dùng &#39;semanage fcontext&#39; để thay đổi type của file</span>
</span></span><span class=line><span class=cl><span class=c1>#                 Hoặc bật boolean: httpd_read_user_content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># audit2allow - Tạo luật allow (THẬN TRỌNG!)</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CẢNH BÁO: Đừng dùng audit2allow mù quáng!</span>
</span></span><span class=line><span class=cl><span class=c1># Nó tạo luật cho phép, có thể tạo lỗ hổng bảo mật</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xem luật sẽ được tạo (không cài đặt)</span>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent <span class=p>|</span> audit2allow
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tạo module (file .te)</span>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent <span class=p>|</span> audit2allow -M mymodule
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cài đặt module</span>
</span></span><span class=line><span class=cl>semodule -i mymodule.pp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># ausearch - Tùy chọn nâng cao</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tìm theo executable</span>
</span></span><span class=line><span class=cl>ausearch -m avc -c httpd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tìm theo source context</span>
</span></span><span class=line><span class=cl>ausearch -m avc --subject httpd_t
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tìm theo target context</span>
</span></span><span class=line><span class=cl>ausearch -m avc --object user_home_t
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tìm theo file</span>
</span></span><span class=line><span class=cl>ausearch -m avc -f /path/to/file</span></span></code></pre></div><h3 class=heading-element id=43-quy-trình-xử-lý-sự-cố><span>4.3 Quy trình xử lý sự cố</span>
<a href=#43-quy-tr%c3%acnh-x%e1%bb%ad-l%c3%bd-s%e1%bb%b1-c%e1%bb%91 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># QUY TRÌNH DEBUG SELINUX</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 1: Xác nhận SELinux gây ra vấn đề</span>
</span></span><span class=line><span class=cl><span class=c1># ──────────────────────────────────────</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tạm chuyển permissive</span>
</span></span><span class=line><span class=cl>setenforce <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Test lại ứng dụng</span>
</span></span><span class=line><span class=cl><span class=c1># - Nếu OK → SELinux gây ra</span>
</span></span><span class=line><span class=cl><span class=c1># - Nếu vẫn lỗi → không phải SELinux</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 2: Tìm denials</span>
</span></span><span class=line><span class=cl><span class=c1># ──────────────────────────────────────</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent
</span></span><span class=line><span class=cl><span class=c1># Hoặc</span>
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;avc:  denied&#34;</span> /var/log/audit/audit.log <span class=p>|</span> tail -20
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 3: Hiểu nguyên nhân</span>
</span></span><span class=line><span class=cl><span class=c1># ──────────────────────────────────────</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent <span class=p>|</span> audit2why
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 4: Kiểm tra nguyên nhân phổ biến</span>
</span></span><span class=line><span class=cl><span class=c1># ──────────────────────────────────────</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4a. File context sai?</span>
</span></span><span class=line><span class=cl>ls -Z /path/to/file
</span></span><span class=line><span class=cl>matchpathcon /path/to/file
</span></span><span class=line><span class=cl><span class=c1># Nếu khác nhau → restorecon</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4b. File ở vị trí không chuẩn?</span>
</span></span><span class=line><span class=cl><span class=c1># Thêm luật fcontext mới</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t correct_type_t <span class=s2>&#34;/custom/path(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>restorecon -Rv /custom/path
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4c. Boolean chưa bật?</span>
</span></span><span class=line><span class=cl>getsebool -a <span class=p>|</span> grep relevant_boolean
</span></span><span class=line><span class=cl>setsebool -P relevant_boolean on
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4d. Port không chuẩn?</span>
</span></span><span class=line><span class=cl>semanage port -l <span class=p>|</span> grep type_t
</span></span><span class=line><span class=cl>semanage port -a -t type_t -p tcp portnumber
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 5: Nếu cần custom policy</span>
</span></span><span class=line><span class=cl><span class=c1># ──────────────────────────────────────</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chỉ khi các bước trên không giải quyết được</span>
</span></span><span class=line><span class=cl><span class=c1># Xem PHẦN 5 để viết policy đúng cách</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 6: Trở lại Enforcing</span>
</span></span><span class=line><span class=cl><span class=c1># ──────────────────────────────────────</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>setenforce <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=c1># Test lại</span></span></span></code></pre></div><h3 class=heading-element id=44-vấn-đề-phổ-biến-và-giải-pháp><span>4.4 Vấn đề phổ biến và giải pháp</span>
<a href=#44-v%e1%ba%a5n-%c4%91%e1%bb%81-ph%e1%bb%95-bi%e1%ba%bfn-v%c3%a0-gi%e1%ba%a3i-ph%c3%a1p class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VẤN ĐỀ 1: Web server không đọc được file</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Triệu chứng: 403 Forbidden, Permission denied</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kiểm tra context</span>
</span></span><span class=line><span class=cl>ls -Z /var/www/custom/index.html
</span></span><span class=line><span class=cl><span class=c1># ...user_home_t...  ← SAI!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sửa: Đặt đúng type</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t httpd_sys_content_t <span class=s2>&#34;/var/www/custom(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>restorecon -Rv /var/www/custom
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VẤN ĐỀ 2: Web server không kết nối được database</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Triệu chứng: Connection refused (nhưng database đang chạy)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kiểm tra boolean</span>
</span></span><span class=line><span class=cl>getsebool httpd_can_network_connect_db
</span></span><span class=line><span class=cl><span class=c1># httpd_can_network_connect_db --&gt; off</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sửa:</span>
</span></span><span class=line><span class=cl>setsebool -P httpd_can_network_connect_db on
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VẤN ĐỀ 3: Service không bind được port tùy chỉnh</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Triệu chứng: Permission denied khi bind port</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kiểm tra port</span>
</span></span><span class=line><span class=cl>semanage port -l <span class=p>|</span> grep <span class=m>8888</span>
</span></span><span class=line><span class=cl><span class=c1># (không có)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sửa: Thêm port</span>
</span></span><span class=line><span class=cl>semanage port -a -t http_port_t -p tcp <span class=m>8888</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VẤN ĐỀ 4: File bị mất context sau khi copy/move</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># mv giữ context, cp không giữ!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sau khi copy, file có context của thư mục đích</span>
</span></span><span class=line><span class=cl>cp /tmp/file /var/www/html/
</span></span><span class=line><span class=cl>ls -Z /var/www/html/file
</span></span><span class=line><span class=cl><span class=c1># ...tmp_t...  ← SAI!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sửa:</span>
</span></span><span class=line><span class=cl>restorecon /var/www/html/file
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Hoặc copy giữ context:</span>
</span></span><span class=line><span class=cl>cp --preserve<span class=o>=</span>context /tmp/file /var/www/html/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VẤN ĐỀ 5: NFS mount không truy cập được</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cách 1: Bật boolean</span>
</span></span><span class=line><span class=cl>setsebool -P httpd_use_nfs on
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cách 2: Mount với context</span>
</span></span><span class=line><span class=cl>mount -t nfs -o <span class=nv>context</span><span class=o>=</span>system_u:object_r:httpd_sys_content_t:s0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    server:/export /var/www/nfs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VẤN ĐỀ 6: Cần relabel toàn bộ filesystem</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Khi có nhiều file bị sai context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cách 1: fixfiles</span>
</span></span><span class=line><span class=cl>fixfiles -F restore
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cách 2: autorelabel khi boot</span>
</span></span><span class=line><span class=cl>touch /.autorelabel
</span></span><span class=line><span class=cl>reboot
</span></span><span class=line><span class=cl><span class=c1># Mất thời gian tùy kích thước filesystem!</span></span></span></code></pre></div><hr><h2 class=heading-element id=phần-5-viết-policy-selinux><span>PHẦN 5: VIẾT POLICY SELINUX</span>
<a href=#ph%e1%ba%a7n-5-vi%e1%ba%bft-policy-selinux class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=51-cấu-trúc-module><span>5.1 Cấu trúc Module</span>
<a href=#51-c%e1%ba%a5u-tr%c3%bac-module class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># CẤU TRÚC MODULE SELINUX</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Một module gồm 3 file:</span>
</span></span><span class=line><span class=cl><span class=c1># - myapp.te   - Type Enforcement (luật chính)</span>
</span></span><span class=line><span class=cl><span class=c1># - myapp.fc   - File Contexts</span>
</span></span><span class=line><span class=cl><span class=c1># - myapp.if   - Interface (cho modules khác dùng)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># FILE .te - TYPE ENFORCEMENT</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; myapp.te <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>policy_module(myapp, 1.0.0)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>########################################
</span></span></span><span class=line><span class=cl><span class=s># Khai báo types
</span></span></span><span class=line><span class=cl><span class=s>########################################
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Domain cho process
</span></span></span><span class=line><span class=cl><span class=s>type myapp_t;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Executable
</span></span></span><span class=line><span class=cl><span class=s>type myapp_exec_t;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># File types
</span></span></span><span class=line><span class=cl><span class=s>type myapp_conf_t;     # Cấu hình
</span></span></span><span class=line><span class=cl><span class=s>type myapp_data_t;     # Dữ liệu
</span></span></span><span class=line><span class=cl><span class=s>type myapp_log_t;      # Log
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>########################################
</span></span></span><span class=line><span class=cl><span class=s># Domain transition
</span></span></span><span class=line><span class=cl><span class=s>########################################
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Khi init chạy myapp_exec_t, process mới có domain myapp_t
</span></span></span><span class=line><span class=cl><span class=s>init_daemon_domain(myapp_t, myapp_exec_t)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>########################################
</span></span></span><span class=line><span class=cl><span class=s># Luật allow
</span></span></span><span class=line><span class=cl><span class=s>########################################
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Đọc cấu hình
</span></span></span><span class=line><span class=cl><span class=s>allow myapp_t myapp_conf_t:file { read open getattr };
</span></span></span><span class=line><span class=cl><span class=s>allow myapp_t myapp_conf_t:dir { search getattr };
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Quản lý dữ liệu
</span></span></span><span class=line><span class=cl><span class=s>allow myapp_t myapp_data_t:file { read write create unlink open getattr setattr };
</span></span></span><span class=line><span class=cl><span class=s>allow myapp_t myapp_data_t:dir { read write add_name remove_name search getattr };
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Ghi log
</span></span></span><span class=line><span class=cl><span class=s>allow myapp_t myapp_log_t:file { append create open getattr setattr };
</span></span></span><span class=line><span class=cl><span class=s>allow myapp_t myapp_log_t:dir { search add_name getattr };
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Mạng
</span></span></span><span class=line><span class=cl><span class=s>allow myapp_t self:tcp_socket { create connect bind listen accept };
</span></span></span><span class=line><span class=cl><span class=s>allow myapp_t self:udp_socket { create bind };
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>########################################
</span></span></span><span class=line><span class=cl><span class=s># Boolean tùy chọn
</span></span></span><span class=line><span class=cl><span class=s>########################################
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>## &lt;desc&gt;
</span></span></span><span class=line><span class=cl><span class=s>## &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=s>## Cho phép myapp kết nối mạng ra ngoài
</span></span></span><span class=line><span class=cl><span class=s>## &lt;/p&gt;
</span></span></span><span class=line><span class=cl><span class=s>## &lt;/desc&gt;
</span></span></span><span class=line><span class=cl><span class=s>gen_tunable(myapp_can_network_connect, false)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>tunable_policy(`myapp_can_network_connect&#39;,`
</span></span></span><span class=line><span class=cl><span class=s>    corenet_tcp_connect_all_ports(myapp_t)
</span></span></span><span class=line><span class=cl><span class=s>&#39;)
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># FILE .fc - FILE CONTEXTS</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; myapp.fc <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s># Executable
</span></span></span><span class=line><span class=cl><span class=s>/usr/bin/myapp          --      gen_context(system_u:object_r:myapp_exec_t,s0)
</span></span></span><span class=line><span class=cl><span class=s>/usr/sbin/myapp         --      gen_context(system_u:object_r:myapp_exec_t,s0)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Cấu hình
</span></span></span><span class=line><span class=cl><span class=s>/etc/myapp(/.*)?                gen_context(system_u:object_r:myapp_conf_t,s0)
</span></span></span><span class=line><span class=cl><span class=s>/etc/myapp\.conf        --      gen_context(system_u:object_r:myapp_conf_t,s0)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Dữ liệu
</span></span></span><span class=line><span class=cl><span class=s>/var/lib/myapp(/.*)?            gen_context(system_u:object_r:myapp_data_t,s0)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Log
</span></span></span><span class=line><span class=cl><span class=s>/var/log/myapp(/.*)?            gen_context(system_u:object_r:myapp_log_t,s0)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># PID file
</span></span></span><span class=line><span class=cl><span class=s>/run/myapp\.pid         --      gen_context(system_u:object_r:myapp_var_run_t,s0)
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BIÊN DỊCH VÀ CÀI ĐẶT</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cần package: selinux-policy-devel</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Biên dịch</span>
</span></span><span class=line><span class=cl>make -f /usr/share/selinux/devel/Makefile myapp.pp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Cài đặt</span>
</span></span><span class=line><span class=cl>semodule -i myapp.pp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Áp dụng file contexts</span>
</span></span><span class=line><span class=cl>restorecon -Rv /usr/bin/myapp /etc/myapp /var/lib/myapp /var/log/myapp</span></span></code></pre></div><h3 class=heading-element id=52-sử-dụng-audit2allow-an-toàn><span>5.2 Sử dụng audit2allow an toàn</span>
<a href=#52-s%e1%bb%ad-d%e1%bb%a5ng-audit2allow-an-to%c3%a0n class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># QUY TRÌNH AN TOÀN VỚI audit2allow</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CẢNH BÁO: Đừng dùng audit2allow mù quáng!</span>
</span></span><span class=line><span class=cl><span class=c1># Nó có thể tạo luật quá rộng, gây lỗ hổng bảo mật</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 1: Đặt domain permissive (KHÔNG phải toàn hệ thống!)</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>semanage permissive -a myapp_t
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 2: Chạy ứng dụng, thực hiện mọi tính năng</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl start myapp
</span></span><span class=line><span class=cl><span class=c1># Thực hiện mọi thao tác ứng dụng cần làm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 3: Thu thập denials</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent --subject myapp_t &gt; /tmp/denials.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 4: Tạo policy</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>audit2allow -i /tmp/denials.txt -M myapp_fix
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 5: KIỂM TRA policy trước khi cài!</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat myapp_fix.te
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TÌM CÁC DẤU HIỆU NGUY HIỂM:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✗ allow myapp_t *:* { ... };</span>
</span></span><span class=line><span class=cl><span class=c1>#   → Quá rộng! Cần xác định rõ target type</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✗ allow myapp_t file_type:file { ... };</span>
</span></span><span class=line><span class=cl><span class=c1>#   → Quá rộng! Cần type cụ thể</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✗ dac_override</span>
</span></span><span class=line><span class=cl><span class=c1>#   → Thường là do quyền Unix sai, sửa chmod/chown thay vì allow</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ✗ execmem, execstack</span>
</span></span><span class=line><span class=cl><span class=c1>#   → Có thể nguy hiểm, kiểm tra xem app có thực sự cần không</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 6: Chỉnh sửa policy nếu cần</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ví dụ: Thay type chung bằng type cụ thể</span>
</span></span><span class=line><span class=cl><span class=c1># Sửa: allow myapp_t file_type:file read;</span>
</span></span><span class=line><span class=cl><span class=c1># Thành: allow myapp_t myapp_data_t:file read;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 7: Cài đặt</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>semodule -i myapp_fix.pp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 8: Bỏ permissive</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>semanage permissive -d myapp_t
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BƯỚC 9: Test trong enforcing</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl restart myapp
</span></span><span class=line><span class=cl><span class=c1># Kiểm tra denials</span>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent --subject myapp_t
</span></span><span class=line><span class=cl><span class=c1># Nếu có denial mới, lặp lại quy trình</span></span></span></code></pre></div><hr><h2 class=heading-element id=phần-6-kiến-trúc-apparmor><span>PHẦN 6: KIẾN TRÚC APPARMOR</span>
<a href=#ph%e1%ba%a7n-6-ki%e1%ba%bfn-tr%c3%bac-apparmor class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=61-pathname-based-mac><span>6.1 Pathname-based MAC</span>
<a href=#61-pathname-based-mac class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>              <span class=n>APPARMOR</span> <span class=o>-</span> <span class=n>PATHNAME</span><span class=o>-</span><span class=n>BASED</span> <span class=n>MAC</span>                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>Đị</span><span class=n>nh</span> <span class=n>nghĩa</span><span class=p>:</span> <span class=n>Kiểm</span> <span class=n>soát</span> <span class=n>truy</span> <span class=n>cập</span> <span class=n>dựa</span> <span class=n>trên</span> <span class=err>đườ</span><span class=n>ng</span> <span class=n>dẫn</span> <span class=n>file</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=n>không</span> <span class=n>gán</span> <span class=n>nhãn</span> <span class=n>vào</span> <span class=n>filesystem</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>SO</span> <span class=n>SÁNH</span> <span class=n>VỚI</span> <span class=n>SELINUX</span>                                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├───────────────────┬─────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=err>Đặ</span><span class=n>c</span> <span class=err>đ</span><span class=n>iểm</span>          <span class=err>│</span> <span class=n>SELinux</span>           <span class=err>│</span> <span class=n>AppArmor</span>            <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├───────────────────┼───────────────────┼─────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Mô</span> <span class=n>hình</span>           <span class=err>│</span> <span class=n>Gán</span> <span class=n>nhãn</span>          <span class=err>│</span> <span class=err>Đườ</span><span class=n>ng</span> <span class=n>dẫn</span>           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Thay</span> <span class=err>đổ</span><span class=n>i</span> <span class=n>FS</span>       <span class=err>│</span> <span class=n>Cần</span> <span class=n>xattr</span>         <span class=err>│</span> <span class=n>Không</span> <span class=n>cần</span>           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=err>Độ</span> <span class=n>phức</span> <span class=n>tạp</span>       <span class=err>│</span> <span class=n>Cao</span>               <span class=err>│</span> <span class=n>Thấp</span> <span class=n>hơn</span>            <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Phạm</span> <span class=n>vi</span>           <span class=err>│</span> <span class=n>Toàn</span> <span class=n>hệ</span> <span class=n>thống</span>     <span class=err>│</span> <span class=n>Từng</span> <span class=err>ứ</span><span class=n>ng</span> <span class=n>dụng</span>       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>Distro</span> <span class=n>mặc</span> <span class=err>đị</span><span class=n>nh</span>   <span class=err>│</span> <span class=n>RHEL</span><span class=p>,</span> <span class=n>Fedora</span>      <span class=err>│</span> <span class=n>Ubuntu</span><span class=p>,</span> <span class=n>SUSE</span>        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=n>MLS</span>               <span class=err>│</span> <span class=n>Hỗ</span> <span class=n>trợ</span>            <span class=err>│</span> <span class=n>Không</span> <span class=n>hỗ</span> <span class=n>trợ</span>        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└───────────────────┴───────────────────┴─────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>THUẬT</span> <span class=n>TOÁN</span> <span class=n>KIỂM</span> <span class=n>TRA</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Yêu</span> <span class=n>cầu</span><span class=p>:</span> <span class=n>Process</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>sbin</span><span class=o>/</span><span class=n>httpd</span> <span class=err>đọ</span><span class=n>c</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>index</span><span class=o>.</span><span class=n>html</span>  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>1.</span> <span class=n>Tìm</span> <span class=n>profile</span> <span class=n>cho</span> <span class=o>/</span><span class=n>usr</span><span class=o>/</span><span class=n>sbin</span><span class=o>/</span><span class=n>httpd</span>                        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=err>→</span> <span class=n>Profile</span> <span class=s2>&#34;apache2&#34;</span>                                    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>2.</span> <span class=n>Kiểm</span> <span class=n>tra</span> <span class=n>luật</span> <span class=n>trong</span> <span class=n>profile</span><span class=p>:</span>                           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/**</span> <span class=n>r</span><span class=p>,</span>                                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>3.</span> <span class=n>So</span> <span class=n>khớp</span> <span class=err>đườ</span><span class=n>ng</span> <span class=n>dẫn</span><span class=p>:</span>                                     <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/</span><span class=n>index</span><span class=o>.</span><span class=n>html</span> <span class=n>khớp</span> <span class=o>/</span><span class=k>var</span><span class=o>/</span><span class=n>www</span><span class=o>/**</span>                   <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>4.</span> <span class=n>Kiểm</span> <span class=n>tra</span> <span class=n>quyền</span><span class=p>:</span>                                        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>      <span class=n>r</span> <span class=p>(</span><span class=err>đọ</span><span class=n>c</span><span class=p>)</span> <span class=err>đượ</span><span class=n>c</span> <span class=n>cho</span> <span class=n>phép</span>                                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=mf>5.</span> <span class=n>Kết</span> <span class=n>quả</span><span class=p>:</span> <span class=n>CHO</span> <span class=n>PHÉP</span>                                      <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>Độ</span> <span class=n>phức</span> <span class=n>tạp</span><span class=p>:</span> <span class=n>O</span><span class=p>(</span><span class=err>độ</span><span class=n>_dài_đường_dẫn</span><span class=p>)</span> <span class=n>với</span> <span class=n>DFA</span><span class=o>/</span><span class=n>trie</span>             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span></span></span></code></pre></div><h3 class=heading-element id=62-thành-phần-apparmor><span>6.2 Thành phần AppArmor</span>
<a href=#62-th%c3%a0nh-ph%e1%ba%a7n-apparmor class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span>              <span class=n>CÁC</span> <span class=n>THÀNH</span> <span class=n>PHẦN</span> <span class=n>APPARMOR</span>                        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=mf>1.</span> <span class=n>PROFILE</span> <span class=n>REPOSITORY</span> <span class=p>(</span><span class=n>Kho</span> <span class=n>profile</span><span class=p>)</span>                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>apparmor</span><span class=o>.</span><span class=n>d</span><span class=o>/</span>                  <span class=n>Thư</span> <span class=n>mục</span> <span class=n>chính</span>           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>usr</span><span class=o>.</span><span class=n>sbin</span><span class=o>.</span><span class=n>apache2</span>              <span class=n>Profile</span> <span class=n>Apache</span>          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>usr</span><span class=o>.</span><span class=n>bin</span><span class=o>.</span><span class=n>firefox</span>               <span class=n>Profile</span> <span class=n>Firefox</span>         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>abstractions</span><span class=o>/</span>                 <span class=n>Luật</span> <span class=n>dùng</span> <span class=n>chung</span>         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=n>base</span>                      <span class=n>Cơ</span> <span class=n>bản</span> <span class=n>cho</span> <span class=n>mọi</span> <span class=n>app</span>      <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=n>nameservice</span>               <span class=n>DNS</span><span class=p>,</span> <span class=n>NSS</span>                <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>└──</span> <span class=o>...</span>                                               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>tunables</span><span class=o>/</span>                     <span class=n>Biến</span> <span class=n>có</span> <span class=n>thể</span> <span class=n>thay</span> <span class=err>đổ</span><span class=n>i</span>    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>├──</span> <span class=n>global</span>                    <span class=n>Biến</span> <span class=n>toàn</span> <span class=n>cục</span>           <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>│</span>   <span class=err>└──</span> <span class=n>home</span>                      <span class=err>Đườ</span><span class=n>ng</span> <span class=n>dẫn</span> <span class=n>home</span>          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>├──</span> <span class=n>local</span><span class=o>/</span>                        <span class=n>Tùy</span> <span class=n>chỉnh</span> <span class=n>local</span>         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=err>└──</span> <span class=n>disable</span><span class=o>/</span>                      <span class=n>Profile</span> <span class=n>bị</span> <span class=n>vô</span> <span class=n>hiệu</span> <span class=n>hóa</span>  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=mf>2.</span> <span class=n>KERNEL</span> <span class=n>MODULE</span>                                            <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Load</span> <span class=n>profiles</span> <span class=err>đã</span> <span class=n>biên</span> <span class=n>dịch</span>                              <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>LSM</span> <span class=n>hooks</span> <span class=n>cho</span> <span class=n>kiểm</span> <span class=n>tra</span> <span class=n>truy</span> <span class=n>cập</span>                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=o>-</span> <span class=n>Ghi</span> <span class=nb>log</span> <span class=n>vi</span> <span class=n>phạm</span>                                         <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>Vị</span> <span class=n>trí</span><span class=p>:</span> <span class=o>/</span><span class=n>sys</span><span class=o>/</span><span class=n>kernel</span><span class=o>/</span><span class=n>security</span><span class=o>/</span><span class=n>apparmor</span><span class=o>/</span>                    <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>┌─────────────────────────────────────────────────────────────┐</span>
</span></span><span class=line><span class=cl><span class=err>│</span> <span class=mf>3.</span> <span class=n>USERSPACE</span> <span class=n>TOOLS</span>                                          <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>├─────────────────────────────────────────────────────────────┤</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>apparmor_parser</span>   <span class=o>-</span> <span class=n>Load</span><span class=o>/</span><span class=n>unload</span> <span class=n>profiles</span>                  <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>aa</span><span class=o>-</span><span class=n>status</span>         <span class=o>-</span> <span class=n>Xem</span> <span class=n>trạng</span> <span class=n>thái</span>                        <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>aa</span><span class=o>-</span><span class=n>enforce</span>        <span class=o>-</span> <span class=n>Chuyển</span> <span class=n>sang</span> <span class=n>enforce</span> <span class=n>mode</span>              <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>aa</span><span class=o>-</span><span class=n>complain</span>       <span class=o>-</span> <span class=n>Chuyển</span> <span class=n>sang</span> <span class=n>complain</span> <span class=n>mode</span>             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>aa</span><span class=o>-</span><span class=n>genprof</span>        <span class=o>-</span> <span class=n>Tạo</span> <span class=n>profile</span> <span class=n>mới</span>                       <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>aa</span><span class=o>-</span><span class=n>logprof</span>        <span class=o>-</span> <span class=n>Cập</span> <span class=n>nhật</span> <span class=n>profile</span> <span class=n>từ</span> <span class=nb>log</span>               <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>   <span class=n>aa</span><span class=o>-</span><span class=n>disable</span>        <span class=o>-</span> <span class=n>Vô</span> <span class=n>hiệu</span> <span class=n>hóa</span> <span class=n>profile</span>                   <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>│</span>                                                             <span class=err>│</span>
</span></span><span class=line><span class=cl><span class=err>└─────────────────────────────────────────────────────────────┘</span></span></span></code></pre></div><h3 class=heading-element id=63-chế-độ-profile><span>6.3 Chế độ Profile</span>
<a href=#63-ch%e1%ba%bf-%c4%91%e1%bb%99-profile class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># CÁC CHẾ ĐỘ PROFILE</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ENFORCE: Thực thi luật, chặn vi phạm</span>
</span></span><span class=line><span class=cl><span class=c1># COMPLAIN: Chỉ ghi log, không chặn (để debug)</span>
</span></span><span class=line><span class=cl><span class=c1># UNCONFINED: Không bị giới hạn (chỉ audit)</span>
</span></span><span class=line><span class=cl><span class=c1># DISABLED: Profile không được load</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># KIỂM TRA TRẠNG THÁI</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>aa-status
</span></span><span class=line><span class=cl><span class=c1># apparmor module được load.</span>
</span></span><span class=line><span class=cl><span class=c1># 42 profiles được load.</span>
</span></span><span class=line><span class=cl><span class=c1># 35 profiles trong chế độ enforce.</span>
</span></span><span class=line><span class=cl><span class=c1># 7 profiles trong chế độ complain.</span>
</span></span><span class=line><span class=cl><span class=c1># 15 processes được định nghĩa.</span>
</span></span><span class=line><span class=cl><span class=c1># 15 processes trong chế độ enforce.</span>
</span></span><span class=line><span class=cl><span class=c1>#    /usr/sbin/apache2 (1234)</span>
</span></span><span class=line><span class=cl><span class=c1>#    ...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chi tiết hơn</span>
</span></span><span class=line><span class=cl>cat /sys/kernel/security/apparmor/profiles
</span></span><span class=line><span class=cl><span class=c1># /usr/sbin/apache2 (enforce)</span>
</span></span><span class=line><span class=cl><span class=c1># /usr/bin/firefox (complain)</span>
</span></span><span class=line><span class=cl><span class=c1># ...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xem profile của process cụ thể</span>
</span></span><span class=line><span class=cl>cat /proc/PID/attr/current
</span></span><span class=line><span class=cl><span class=c1># /usr/sbin/apache2 (enforce)</span></span></span></code></pre></div><h3 class=heading-element id=64-cú-pháp-profile><span>6.4 Cú pháp Profile</span>
<a href=#64-c%c3%ba-ph%c3%a1p-profile class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># CẤU TRÚC PROFILE CƠ BẢN</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Profile được đặt tên theo đường dẫn executable</span>
</span></span><span class=line><span class=cl><span class=c1># Dấu / thay bằng . trong tên file</span>
</span></span><span class=line><span class=cl><span class=c1># /usr/sbin/apache2 → usr.sbin.apache2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; /etc/apparmor.d/usr.sbin.myapp <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#include &lt;tunables/global&gt;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>profile myapp /usr/sbin/myapp flags=(complain) {
</span></span></span><span class=line><span class=cl><span class=s>  #include &lt;abstractions/base&gt;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Capabilities
</span></span></span><span class=line><span class=cl><span class=s>  capability net_bind_service,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # File rules
</span></span></span><span class=line><span class=cl><span class=s>  /etc/myapp/** r,
</span></span></span><span class=line><span class=cl><span class=s>  /var/lib/myapp/** rw,
</span></span></span><span class=line><span class=cl><span class=s>  /var/log/myapp/** w,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Network
</span></span></span><span class=line><span class=cl><span class=s>  network inet stream,
</span></span></span><span class=line><span class=cl><span class=s>  network inet dgram,
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># FILE PERMISSIONS</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># r  - read (đọc)</span>
</span></span><span class=line><span class=cl><span class=c1># w  - write (ghi)</span>
</span></span><span class=line><span class=cl><span class=c1># a  - append (ghi thêm)</span>
</span></span><span class=line><span class=cl><span class=c1># x  - execute (chạy)</span>
</span></span><span class=line><span class=cl><span class=c1># m  - memory map executable (mmap PROT_EXEC)</span>
</span></span><span class=line><span class=cl><span class=c1># k  - lock (khóa file)</span>
</span></span><span class=line><span class=cl><span class=c1># l  - link (tạo hard link)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># EXECUTE modes:</span>
</span></span><span class=line><span class=cl><span class=c1># ix - inherit profile (kế thừa profile hiện tại)</span>
</span></span><span class=line><span class=cl><span class=c1># px - discrete profile (chuyển sang profile riêng)</span>
</span></span><span class=line><span class=cl><span class=c1># Px - discrete profile (bắt buộc tồn tại)</span>
</span></span><span class=line><span class=cl><span class=c1># ux - unconfined (không giới hạn - NGUY HIỂM!)</span>
</span></span><span class=line><span class=cl><span class=c1># Ux - unconfined (bắt buộc không giới hạn)</span>
</span></span><span class=line><span class=cl><span class=c1># cx - child profile (profile con)</span>
</span></span><span class=line><span class=cl><span class=c1># Cx - child profile (bắt buộc tồn tại)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># PATH PATTERNS</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># *      - khớp bất kỳ ký tự nào trừ /</span>
</span></span><span class=line><span class=cl><span class=c1># **     - khớp bất kỳ ký tự nào kể cả /</span>
</span></span><span class=line><span class=cl><span class=c1># ?      - khớp một ký tự bất kỳ</span>
</span></span><span class=line><span class=cl><span class=c1># [abc]  - khớp a, b, hoặc c</span>
</span></span><span class=line><span class=cl><span class=c1># [a-z]  - khớp a đến z</span>
</span></span><span class=line><span class=cl><span class=c1># {a,b}  - khớp a hoặc b</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ví dụ:</span>
</span></span><span class=line><span class=cl>/var/www/*           <span class=c1># /var/www/index.html (không phải subdir)</span>
</span></span><span class=line><span class=cl>/var/www/**          <span class=c1># /var/www/subdir/file.html</span>
</span></span><span class=line><span class=cl>/var/www/*.html      <span class=c1># Chỉ file .html</span>
</span></span><span class=line><span class=cl>/home/*/public_html/** r,  <span class=c1># Tất cả user public_html</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VARIABLES (Biến)</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Định nghĩa trong /etc/apparmor.d/tunables/</span>
</span></span><span class=line><span class=cl>@<span class=o>{</span>HOME<span class=o>}=</span>/home/*      <span class=c1># Home directory</span>
</span></span><span class=line><span class=cl>@<span class=o>{</span>HOMEDIRS<span class=o>}=</span>/home/   <span class=c1># Home parent</span>
</span></span><span class=line><span class=cl>@<span class=o>{</span>multiarch<span class=o>}=</span>*-linux-gnu*  <span class=c1># Multiarch paths</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sử dụng</span>
</span></span><span class=line><span class=cl>owner @<span class=o>{</span>HOME<span class=o>}</span>/** rw,
</span></span><span class=line><span class=cl>/usr/lib/@<span class=o>{</span>multiarch<span class=o>}</span>/** mr,</span></span></code></pre></div><hr><h2 class=heading-element id=phần-7-vận-hành-apparmor><span>PHẦN 7: VẬN HÀNH APPARMOR</span>
<a href=#ph%e1%ba%a7n-7-v%e1%ba%adn-h%c3%a0nh-apparmor class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=71-quản-lý-chế-độ><span>7.1 Quản lý chế độ</span>
<a href=#71-qu%e1%ba%a3n-l%c3%bd-ch%e1%ba%bf-%c4%91%e1%bb%99 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># THAY ĐỔI CHẾ ĐỘ PROFILE</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chuyển sang enforce</span>
</span></span><span class=line><span class=cl>aa-enforce /etc/apparmor.d/usr.sbin.apache2
</span></span><span class=line><span class=cl>aa-enforce /usr/sbin/apache2    <span class=c1># Hoặc dùng đường dẫn executable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chuyển sang complain</span>
</span></span><span class=line><span class=cl>aa-complain /etc/apparmor.d/usr.sbin.apache2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vô hiệu hóa</span>
</span></span><span class=line><span class=cl>aa-disable /etc/apparmor.d/usr.sbin.apache2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chuyển sang audit (log tất cả, kể cả allowed)</span>
</span></span><span class=line><span class=cl>aa-audit /etc/apparmor.d/usr.sbin.apache2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># LOAD/UNLOAD PROFILES</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Reload profile sau khi sửa</span>
</span></span><span class=line><span class=cl>apparmor_parser -r /etc/apparmor.d/usr.sbin.apache2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load profile mới</span>
</span></span><span class=line><span class=cl>apparmor_parser -a /etc/apparmor.d/usr.sbin.newapp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Unload profile</span>
</span></span><span class=line><span class=cl>apparmor_parser -R /etc/apparmor.d/usr.sbin.apache2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Reload tất cả profiles</span>
</span></span><span class=line><span class=cl>systemctl reload apparmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># QUẢN LÝ SERVICE</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xem trạng thái</span>
</span></span><span class=line><span class=cl>systemctl status apparmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Khởi động</span>
</span></span><span class=line><span class=cl>systemctl start apparmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Dừng (unload tất cả profiles)</span>
</span></span><span class=line><span class=cl>systemctl stop apparmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Restart</span>
</span></span><span class=line><span class=cl>systemctl restart apparmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bật/tắt khi boot</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> apparmor
</span></span><span class=line><span class=cl>systemctl disable apparmor</span></span></code></pre></div><h3 class=heading-element id=72-tạo-profile-mới><span>7.2 Tạo profile mới</span>
<a href=#72-t%e1%ba%a1o-profile-m%e1%bb%9bi class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># aa-genprof - Tạo profile tương tác (KHUYẾN NGHỊ)</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 1: Chạy aa-genprof</span>
</span></span><span class=line><span class=cl>aa-genprof /usr/bin/myapp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># aa-genprof sẽ:</span>
</span></span><span class=line><span class=cl><span class=c1># 1. Tạo profile rỗng trong complain mode</span>
</span></span><span class=line><span class=cl><span class=c1># 2. Bảo bạn chạy ứng dụng trong terminal khác</span>
</span></span><span class=line><span class=cl><span class=c1># 3. Quét log và hỏi từng access</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 2: Trong terminal khác, chạy ứng dụng</span>
</span></span><span class=line><span class=cl>/usr/bin/myapp
</span></span><span class=line><span class=cl><span class=c1># Thực hiện mọi thao tác ứng dụng cần làm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 3: Quay lại aa-genprof, nhấn &#39;S&#39; để scan log</span>
</span></span><span class=line><span class=cl><span class=c1># Với mỗi access, chọn:</span>
</span></span><span class=line><span class=cl><span class=c1># (A)llow - Cho phép</span>
</span></span><span class=line><span class=cl><span class=c1># (D)eny - Từ chối</span>
</span></span><span class=line><span class=cl><span class=c1># (I)gnore - Bỏ qua</span>
</span></span><span class=line><span class=cl><span class=c1># (G)lob - Dùng pattern</span>
</span></span><span class=line><span class=cl><span class=c1># (N)ew - Profile mới cho executable</span>
</span></span><span class=line><span class=cl><span class=c1># (S)ave - Lưu và thoát</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># aa-autodep - Tạo profile skeleton</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tạo profile cơ bản</span>
</span></span><span class=line><span class=cl>aa-autodep /usr/bin/myapp
</span></span><span class=line><span class=cl><span class=c1># Tạo /etc/apparmor.d/usr.bin.myapp với base abstractions</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sau đó dùng aa-logprof để thêm luật</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># aa-easyprof - Tạo profile từ template</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liệt kê templates</span>
</span></span><span class=line><span class=cl>aa-easyprof --list-templates
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tạo profile từ template</span>
</span></span><span class=line><span class=cl>aa-easyprof --template<span class=o>=</span>user-application <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --template-var<span class=o>=</span><span class=s2>&#34;@{APP}=/usr/bin/myapp&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    /usr/bin/myapp</span></span></code></pre></div><h3 class=heading-element id=73-cập-nhật-profile><span>7.3 Cập nhật profile</span>
<a href=#73-c%e1%ba%adp-nh%e1%ba%adt-profile class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># aa-logprof - Cập nhật profile từ log</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chạy sau khi ứng dụng có violations trong log</span>
</span></span><span class=line><span class=cl>aa-logprof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chỉ định file log</span>
</span></span><span class=line><span class=cl>aa-logprof -f /var/log/syslog
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Quy trình:</span>
</span></span><span class=line><span class=cl><span class=c1># 1. Đặt profile complain mode</span>
</span></span><span class=line><span class=cl>aa-complain /etc/apparmor.d/usr.sbin.myapp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. Chạy ứng dụng, thực hiện các thao tác</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. Chạy aa-logprof</span>
</span></span><span class=line><span class=cl>aa-logprof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. Với mỗi access mới, chọn:</span>
</span></span><span class=line><span class=cl><span class=c1>#    (A)llow - Cho phép</span>
</span></span><span class=line><span class=cl><span class=c1>#    (D)eny - Từ chối</span>
</span></span><span class=line><span class=cl><span class=c1>#    (I)gnore - Bỏ qua</span>
</span></span><span class=line><span class=cl><span class=c1>#    (G)lob - Dùng pattern</span>
</span></span><span class=line><span class=cl><span class=c1>#    Chọn owner nếu chỉ cho user sở hữu</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. Lưu và chuyển enforce</span>
</span></span><span class=line><span class=cl>aa-enforce /etc/apparmor.d/usr.sbin.myapp</span></span></code></pre></div><h3 class=heading-element id=74-xem-và-debug-violations><span>7.4 Xem và debug violations</span>
<a href=#74-xem-v%c3%a0-debug-violations class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># XEM VIOLATIONS</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># dmesg</span>
</span></span><span class=line><span class=cl>dmesg <span class=p>|</span> grep apparmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># syslog</span>
</span></span><span class=line><span class=cl>grep apparmor /var/log/syslog
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># audit log (nếu auditd chạy)</span>
</span></span><span class=line><span class=cl>ausearch -m apparmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kernel log realtime</span>
</span></span><span class=line><span class=cl>dmesg -w <span class=p>|</span> grep apparmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># ĐỌC HIỂU DENIAL MESSAGE</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ví dụ:</span>
</span></span><span class=line><span class=cl><span class=c1># apparmor=&#34;DENIED&#34; operation=&#34;open&#34; profile=&#34;firefox&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># name=&#34;/etc/passwd&#34; pid=1234 comm=&#34;firefox&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># requested_mask=&#34;r&#34; denied_mask=&#34;r&#34; fsuid=1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Phân tích:</span>
</span></span><span class=line><span class=cl><span class=c1># apparmor=&#34;DENIED&#34;     → Bị chặn (ALLOWED = cho phép khi audit)</span>
</span></span><span class=line><span class=cl><span class=c1># operation=&#34;open&#34;      → Thao tác: mở file</span>
</span></span><span class=line><span class=cl><span class=c1># profile=&#34;firefox&#34;     → Profile chặn</span>
</span></span><span class=line><span class=cl><span class=c1># name=&#34;/etc/passwd&#34;    → File bị truy cập</span>
</span></span><span class=line><span class=cl><span class=c1># requested_mask=&#34;r&#34;    → Quyền yêu cầu: đọc</span>
</span></span><span class=line><span class=cl><span class=c1># denied_mask=&#34;r&#34;       → Quyền bị chặn: đọc</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># CÔNG CỤ DEBUG</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Decode log entry</span>
</span></span><span class=line><span class=cl>aa-decode <span class=s2>&#34;thông điệp audit đã encode&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Notifications (GNOME)</span>
</span></span><span class=line><span class=cl>aa-notify -p
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Liệt kê processes không có profile</span>
</span></span><span class=line><span class=cl>aa-unconfined
</span></span><span class=line><span class=cl><span class=c1># Hiện processes có network socket nhưng không có profile</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># QUY TRÌNH DEBUG</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. Chuyển complain</span>
</span></span><span class=line><span class=cl>aa-complain /etc/apparmor.d/profile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. Chạy ứng dụng</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. Xem violations</span>
</span></span><span class=line><span class=cl>dmesg <span class=p>|</span> grep apparmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. Cập nhật profile</span>
</span></span><span class=line><span class=cl>aa-logprof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. Chuyển enforce</span>
</span></span><span class=line><span class=cl>aa-enforce /etc/apparmor.d/profile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. Test lại</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># KIỂM TRA SYNTAX</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Parse không load</span>
</span></span><span class=line><span class=cl>apparmor_parser -p /etc/apparmor.d/profile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Verbose</span>
</span></span><span class=line><span class=cl>apparmor_parser -v /etc/apparmor.d/profile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Xem profile của process</span>
</span></span><span class=line><span class=cl>cat /proc/PID/attr/current</span></span></code></pre></div><hr><h2 class=heading-element id=phần-8-viết-profile-apparmor><span>PHẦN 8: VIẾT PROFILE APPARMOR</span>
<a href=#ph%e1%ba%a7n-8-vi%e1%ba%bft-profile-apparmor class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=81-profile-hoàn-chỉnh><span>8.1 Profile hoàn chỉnh</span>
<a href=#81-profile-ho%c3%a0n-ch%e1%bb%89nh class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VÍ DỤ PROFILE HOÀN CHỈNH</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat &gt; /etc/apparmor.d/usr.sbin.myapp <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#include &lt;tunables/global&gt;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>profile myapp /usr/sbin/myapp flags=(attach_disconnected) {
</span></span></span><span class=line><span class=cl><span class=s>  #include &lt;abstractions/base&gt;
</span></span></span><span class=line><span class=cl><span class=s>  #include &lt;abstractions/nameservice&gt;
</span></span></span><span class=line><span class=cl><span class=s>  #include &lt;abstractions/openssl&gt;
</span></span></span><span class=line><span class=cl><span class=s>  #include &lt;abstractions/python&gt;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>  # CAPABILITIES
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  capability net_bind_service,  # Bind port &lt; 1024
</span></span></span><span class=line><span class=cl><span class=s>  capability setuid,
</span></span></span><span class=line><span class=cl><span class=s>  capability setgid,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>  # NETWORK
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  network inet stream,          # TCP
</span></span></span><span class=line><span class=cl><span class=s>  network inet dgram,           # UDP
</span></span></span><span class=line><span class=cl><span class=s>  network inet6 stream,         # TCP IPv6
</span></span></span><span class=line><span class=cl><span class=s>  network unix stream,          # Unix socket
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>  # SIGNALS
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  signal send set=(term, kill) peer=myapp,
</span></span></span><span class=line><span class=cl><span class=s>  signal receive set=(term, kill) peer=unconfined,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>  # FILE RULES
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Executable
</span></span></span><span class=line><span class=cl><span class=s>  /usr/sbin/myapp               mr,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Cấu hình (chỉ đọc)
</span></span></span><span class=line><span class=cl><span class=s>  /etc/myapp/                   r,
</span></span></span><span class=line><span class=cl><span class=s>  /etc/myapp/**                 r,
</span></span></span><span class=line><span class=cl><span class=s>  /etc/myapp/secrets.conf       r,   # File cụ thể
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Dữ liệu (đọc/ghi)
</span></span></span><span class=line><span class=cl><span class=s>  /var/lib/myapp/               rw,
</span></span></span><span class=line><span class=cl><span class=s>  /var/lib/myapp/**             rw,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Logs (ghi, append)
</span></span></span><span class=line><span class=cl><span class=s>  /var/log/myapp/               rw,
</span></span></span><span class=line><span class=cl><span class=s>  /var/log/myapp/**             w,
</span></span></span><span class=line><span class=cl><span class=s>  /var/log/myapp/*.log          a,   # Chỉ append
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # PID file
</span></span></span><span class=line><span class=cl><span class=s>  /run/myapp/                   rw,
</span></span></span><span class=line><span class=cl><span class=s>  /run/myapp/myapp.pid          rw,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Temp files
</span></span></span><span class=line><span class=cl><span class=s>  owner /tmp/myapp.*            rw,
</span></span></span><span class=line><span class=cl><span class=s>  /tmp/myapp-*/                 rw,
</span></span></span><span class=line><span class=cl><span class=s>  /tmp/myapp-*/**               rw,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Libraries
</span></span></span><span class=line><span class=cl><span class=s>  /usr/lib/@{multiarch}/**      mr,
</span></span></span><span class=line><span class=cl><span class=s>  /lib/@{multiarch}/**          mr,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>  # CHILD PROFILES (Chạy sub-processes)
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Chạy helper với profile riêng
</span></span></span><span class=line><span class=cl><span class=s>  /usr/lib/myapp/helper         Cx -&gt; myapp_helper,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  profile myapp_helper {
</span></span></span><span class=line><span class=cl><span class=s>    #include &lt;abstractions/base&gt;
</span></span></span><span class=line><span class=cl><span class=s>    /usr/lib/myapp/helper       mr,
</span></span></span><span class=line><span class=cl><span class=s>    /var/lib/myapp/cache/**     rw,
</span></span></span><span class=line><span class=cl><span class=s>  }
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>  # EXTERNAL EXECUTABLES
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Chạy với profile riêng của nó
</span></span></span><span class=line><span class=cl><span class=s>  /usr/bin/curl                 Px,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # Kế thừa profile hiện tại
</span></span></span><span class=line><span class=cl><span class=s>  /bin/cat                      ix,
</span></span></span><span class=line><span class=cl><span class=s>  /bin/grep                     ix,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>  # DENY RULES (Từ chối rõ ràng)
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  deny /etc/shadow              r,
</span></span></span><span class=line><span class=cl><span class=s>  deny /etc/gshadow             r,
</span></span></span><span class=line><span class=cl><span class=s>  deny @{HOME}/.ssh/**          rw,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>  # LOCAL CUSTOMIZATIONS
</span></span></span><span class=line><span class=cl><span class=s>  # ═══════════════════════════════════════════════════════
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>  #include &lt;local/usr.sbin.myapp&gt;
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tạo file local customization (rỗng ban đầu)</span>
</span></span><span class=line><span class=cl>touch /etc/apparmor.d/local/usr.sbin.myapp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load profile</span>
</span></span><span class=line><span class=cl>apparmor_parser -r /etc/apparmor.d/usr.sbin.myapp</span></span></code></pre></div><h3 class=heading-element id=82-abstractions><span>8.2 Abstractions</span>
<a href=#82-abstractions class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># ABSTRACTIONS PHỔ BIẾN</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vị trí: /etc/apparmor.d/abstractions/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># ABSTRACTIONS CƠ BẢN</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>base          <span class=c1># Thiết yếu cho hầu hết apps</span>
</span></span><span class=line><span class=cl>              <span class=c1># /etc/ld.so.cache, locales, /dev/null, etc.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nameservice   <span class=c1># DNS, NSS</span>
</span></span><span class=line><span class=cl>              <span class=c1># /etc/hosts, /etc/resolv.conf, nsswitch</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>authentication <span class=c1># PAM, NSS authentication</span>
</span></span><span class=line><span class=cl>              <span class=c1># /etc/pam.d/, /etc/security/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>openssl       <span class=c1># SSL/TLS certificates</span>
</span></span><span class=line><span class=cl>              <span class=c1># /etc/ssl/, CA certificates</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># ABSTRACTIONS NGÔN NGỮ</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>python        <span class=c1># Python interpreter và libraries</span>
</span></span><span class=line><span class=cl>perl          <span class=c1># Perl interpreter và libraries</span>
</span></span><span class=line><span class=cl>bash          <span class=c1># Bash và common shell utilities</span>
</span></span><span class=line><span class=cl>ruby          <span class=c1># Ruby interpreter và libraries</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># ABSTRACTIONS USER</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>user-tmp      <span class=c1># /tmp, /var/tmp cho user files</span>
</span></span><span class=line><span class=cl>private-files <span class=c1># Deny access ~/.gnupg, ~/.ssh, etc.</span>
</span></span><span class=line><span class=cl>              <span class=c1># Dùng để bảo vệ secrets</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>private-files-strict  <span class=c1># Stricter version</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># ABSTRACTIONS DESKTOP</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>gnome         <span class=c1># GNOME desktop integration</span>
</span></span><span class=line><span class=cl>kde           <span class=c1># KDE desktop integration</span>
</span></span><span class=line><span class=cl>X             <span class=c1># X11 display access</span>
</span></span><span class=line><span class=cl>dbus-session  <span class=c1># D-Bus session bus</span>
</span></span><span class=line><span class=cl>audio         <span class=c1># Audio devices (ALSA, PulseAudio)</span>
</span></span><span class=line><span class=cl>video         <span class=c1># Video devices</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># SỬ DỤNG TRONG PROFILE</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>profile myapp /usr/bin/myapp <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>#include &lt;abstractions/base&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#include &lt;abstractions/nameservice&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#include &lt;abstractions/openssl&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#include &lt;abstractions/python&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Bảo vệ private files</span>
</span></span><span class=line><span class=cl>  <span class=c1>#include &lt;abstractions/private-files&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># ... các luật khác</span>
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><h3 class=heading-element id=83-tunables><span>8.3 Tunables</span>
<a href=#83-tunables class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># TUNABLES - Biến có thể thay đổi</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vị trí: /etc/apparmor.d/tunables/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># BIẾN CÓ SẴN</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># tunables/global</span>
</span></span><span class=line><span class=cl>@<span class=o>{</span>HOME<span class=o>}=</span>/home/*
</span></span><span class=line><span class=cl>@<span class=o>{</span>HOMEDIRS<span class=o>}=</span>/home/
</span></span><span class=line><span class=cl>@<span class=o>{</span>multiarch<span class=o>}=</span>*-linux-gnu*
</span></span><span class=line><span class=cl>@<span class=o>{</span>user_share<span class=o>}=</span>@<span class=o>{</span>HOME<span class=o>}</span>/.local/share
</span></span><span class=line><span class=cl>@<span class=o>{</span>run<span class=o>}=</span>/run
</span></span><span class=line><span class=cl>@<span class=o>{</span>sys<span class=o>}=</span>/sys
</span></span><span class=line><span class=cl>@<span class=o>{</span>proc<span class=o>}=</span>/proc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># tunables/home</span>
</span></span><span class=line><span class=cl><span class=c1># Có thể override @{HOME} cho hệ thống cụ thể</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># SỬ DỤNG TRONG PROFILE</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>profile myapp /usr/bin/myapp <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>#include &lt;tunables/global&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1># Sử dụng biến</span>
</span></span><span class=line><span class=cl>  owner @<span class=o>{</span>HOME<span class=o>}</span>/.config/myapp/** rw,
</span></span><span class=line><span class=cl>  owner @<span class=o>{</span>HOME<span class=o>}</span>/.local/share/myapp/** rw,
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  /usr/lib/@<span class=o>{</span>multiarch<span class=o>}</span>/** mr,
</span></span><span class=line><span class=cl>  @<span class=o>{</span>run<span class=o>}</span>/myapp.pid rw,
</span></span><span class=line><span class=cl>  @<span class=o>{</span>sys<span class=o>}</span>/devices/** r,
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># TÙY CHỈNH TUNABLES</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tạo file tùy chỉnh</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/apparmor.d/tunables/mysite <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s># Định nghĩa riêng cho site này
</span></span></span><span class=line><span class=cl><span class=s>@{WEBROOT}=/srv/www
</span></span></span><span class=line><span class=cl><span class=s>@{LOGDIR}=/var/log/custom
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sử dụng trong profile</span>
</span></span><span class=line><span class=cl>profile mywebapp /usr/bin/mywebapp <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>#include &lt;tunables/global&gt;</span>
</span></span><span class=line><span class=cl>  <span class=c1>#include &lt;tunables/mysite&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  @<span class=o>{</span>WEBROOT<span class=o>}</span>/** r,
</span></span><span class=line><span class=cl>  @<span class=o>{</span>LOGDIR<span class=o>}</span>/mywebapp/** w,
</span></span><span class=line><span class=cl><span class=o>}</span></span></span></code></pre></div><h3 class=heading-element id=84-local-customizations><span>8.4 Local customizations</span>
<a href=#84-local-customizations class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># LOCAL CUSTOMIZATIONS</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Mục đích: Thêm luật mà không sửa profile gốc</span>
</span></span><span class=line><span class=cl><span class=c1># Lợi ích: Không bị ghi đè khi package update</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Vị trí: /etc/apparmor.d/local/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># VÍ DỤ</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Profile gốc có dòng:</span>
</span></span><span class=line><span class=cl><span class=c1>#include &lt;local/usr.sbin.apache2&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tạo local customization:</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/apparmor.d/local/usr.sbin.apache2 <span class=s>&lt;&lt; &#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s># Thêm đường dẫn custom cho site này
</span></span></span><span class=line><span class=cl><span class=s>/srv/mysite/** r,
</span></span></span><span class=line><span class=cl><span class=s>/var/log/mysite/** w,
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># Cho phép kết nối đến backend
</span></span></span><span class=line><span class=cl><span class=s>network inet stream,
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Reload profile</span>
</span></span><span class=line><span class=cl>apparmor_parser -r /etc/apparmor.d/usr.sbin.apache2</span></span></code></pre></div><hr><h2 class=heading-element id=phần-9-so-sánh--trường-hợp-sử-dụng><span>PHẦN 9: SO SÁNH & TRƯỜNG HỢP SỬ DỤNG</span>
<a href=#ph%e1%ba%a7n-9-so-s%c3%a1nh--tr%c6%b0%e1%bb%9dng-h%e1%bb%a3p-s%e1%bb%ad-d%e1%bb%a5ng class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=91-bảng-so-sánh-chi-tiết><span>9.1 Bảng so sánh chi tiết</span>
<a href=#91-b%e1%ba%a3ng-so-s%c3%a1nh-chi-ti%e1%ba%bft class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│              SO SÁNH SELINUX VS APPARMOR                    │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌────────────────────┬─────────────────┬──────────────────────┐
</span></span><span class=line><span class=cl>│ Đặc điểm           │ SELinux         │ AppArmor             │
</span></span><span class=line><span class=cl>├────────────────────┼─────────────────┼──────────────────────┤
</span></span><span class=line><span class=cl>│ Mô hình            │ Gán nhãn        │ Đường dẫn            │
</span></span><span class=line><span class=cl>│ Đường cong học     │ Dốc             │ Thoải hơn            │
</span></span><span class=line><span class=cl>│ Distro mặc định    │ RHEL, Fedora    │ Ubuntu, SUSE         │
</span></span><span class=line><span class=cl>│                    │ CentOS          │ Debian (tùy chọn)    │
</span></span><span class=line><span class=cl>├────────────────────┼─────────────────┼──────────────────────┤
</span></span><span class=line><span class=cl>│ Thay đổi FS        │ Cần xattr       │ Không cần            │
</span></span><span class=line><span class=cl>│ Di chuyển file     │ Context có thể  │ Không ảnh hưởng      │
</span></span><span class=line><span class=cl>│                    │ thay đổi        │                      │
</span></span><span class=line><span class=cl>│ NFS/CIFS           │ Cần cấu hình    │ Hoạt động mặc định   │
</span></span><span class=line><span class=cl>├────────────────────┼─────────────────┼──────────────────────┤
</span></span><span class=line><span class=cl>│ Phạm vi            │ Toàn hệ thống   │ Từng ứng dụng        │
</span></span><span class=line><span class=cl>│ MLS/MCS            │ Có              │ Không                │
</span></span><span class=line><span class=cl>│ RBAC               │ Có              │ Hạn chế              │
</span></span><span class=line><span class=cl>├────────────────────┼─────────────────┼──────────────────────┤
</span></span><span class=line><span class=cl>│ Công cụ debug      │ audit2why       │ aa-logprof           │
</span></span><span class=line><span class=cl>│                    │ sealert         │ aa-genprof           │
</span></span><span class=line><span class=cl>│ Tạo policy         │ Phức tạp        │ Đơn giản hơn         │
</span></span><span class=line><span class=cl>├────────────────────┼─────────────────┼──────────────────────┤
</span></span><span class=line><span class=cl>│ Container          │ MCS categories  │ Profile per container│
</span></span><span class=line><span class=cl>│ Kubernetes         │ Tích hợp tốt    │ Hỗ trợ               │
</span></span><span class=line><span class=cl>└────────────────────┴─────────────────┴──────────────────────┘</span></span></code></pre></div><h3 class=heading-element id=92-khi-nào-dùng-gì><span>9.2 Khi nào dùng gì</span>
<a href=#92-khi-n%c3%a0o-d%c3%b9ng-g%c3%ac class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│              KHI NÀO DÙNG SELINUX                           │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Môi trường enterprise, quy định nghiêm ngặt
</span></span><span class=line><span class=cl>  - PCI-DSS, HIPAA, SOC2 thường yêu cầu SELinux
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Cần Multi-Level Security (MLS)
</span></span><span class=line><span class=cl>  - Môi trường chính phủ, quân sự
</span></span><span class=line><span class=cl>  - Phân loại dữ liệu theo mức độ mật
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Cách ly container mạnh
</span></span><span class=line><span class=cl>  - sVirt, MCS categories
</span></span><span class=line><span class=cl>  - Mỗi container có category riêng
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Hệ sinh thái RHEL
</span></span><span class=line><span class=cl>  - RHEL, CentOS, Fedora, Rocky, Alma
</span></span><span class=line><span class=cl>  - Policy có sẵn, được bảo trì tốt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Kiểm soát mạng chi tiết
</span></span><span class=line><span class=cl>  - Port types, network node controls
</span></span><span class=line><span class=cl>  - Labeled networking
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>┌─────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│              KHI NÀO DÙNG APPARMOR                          │
</span></span><span class=line><span class=cl>└─────────────────────────────────────────────────────────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Yêu cầu đơn giản hơn
</span></span><span class=line><span class=cl>  - Không cần MLS
</span></span><span class=line><span class=cl>  - Giới hạn một số ứng dụng cụ thể
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Triển khai nhanh
</span></span><span class=line><span class=cl>  - aa-genprof tạo profile trong phút
</span></span><span class=line><span class=cl>  - Ít cấu hình hơn
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Desktop/workstation
</span></span><span class=line><span class=cl>  - Firefox, Thunderbird có profile sẵn
</span></span><span class=line><span class=cl>  - Snap packages dùng AppArmor
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Hệ sinh thái Ubuntu/SUSE
</span></span><span class=line><span class=cl>  - Ubuntu, Debian, openSUSE
</span></span><span class=line><span class=cl>  - Tích hợp mặc định
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>✓ Nhân sự hạn chế
</span></span><span class=line><span class=cl>  - Đường cong học thoải hơn
</span></span><span class=line><span class=cl>  - Dễ troubleshoot hơn</span></span></code></pre></div><h3 class=heading-element id=93-so-sánh-theo-use-case><span>9.3 So sánh theo use case</span>
<a href=#93-so-s%c3%a1nh-theo-use-case class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># USE CASE 1: WEB SERVER</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SELinux:</span>
</span></span><span class=line><span class=cl><span class=c1># - Gán nhãn nội dung: httpd_sys_content_t</span>
</span></span><span class=line><span class=cl><span class=c1># - Boolean: httpd_can_network_connect_db</span>
</span></span><span class=line><span class=cl><span class=c1># - Port: semanage port -a -t http_port_t</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t httpd_sys_content_t <span class=s2>&#34;/srv/www(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>restorecon -Rv /srv/www
</span></span><span class=line><span class=cl>setsebool -P httpd_can_network_connect_db on
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># AppArmor:</span>
</span></span><span class=line><span class=cl><span class=c1># - Thêm path vào profile</span>
</span></span><span class=line><span class=cl><span class=c1># /srv/www/** r,</span>
</span></span><span class=line><span class=cl><span class=c1># network inet stream,</span>
</span></span><span class=line><span class=cl>aa-complain /etc/apparmor.d/usr.sbin.apache2
</span></span><span class=line><span class=cl><span class=c1># Thêm luật vào /etc/apparmor.d/local/usr.sbin.apache2</span>
</span></span><span class=line><span class=cl>aa-enforce /etc/apparmor.d/usr.sbin.apache2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># USE CASE 2: DATABASE</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SELinux:</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t postgresql_db_t <span class=s2>&#34;/data/postgres(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>restorecon -Rv /data/postgres
</span></span><span class=line><span class=cl>semanage port -a -t postgresql_port_t -p tcp <span class=m>5433</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># AppArmor:</span>
</span></span><span class=line><span class=cl><span class=c1># Sửa /etc/apparmor.d/usr.lib.postgresql.*</span>
</span></span><span class=line><span class=cl><span class=c1># /data/postgres/** rw,</span>
</span></span><span class=line><span class=cl>apparmor_parser -r /etc/apparmor.d/usr.lib.postgresql.*
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># USE CASE 3: CONTAINERS</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SELinux với Docker:</span>
</span></span><span class=line><span class=cl><span class=c1># MCS categories tự động</span>
</span></span><span class=line><span class=cl>docker run -v /data:/data:Z nginx    <span class=c1># Z = relabel private</span>
</span></span><span class=line><span class=cl>docker run -v /data:/data:z nginx    <span class=c1># z = relabel shared</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Kiểm tra</span>
</span></span><span class=line><span class=cl>ps auxZ <span class=p>|</span> grep nginx
</span></span><span class=line><span class=cl><span class=c1># system_u:system_r:container_t:s0:c123,c456</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># AppArmor với Docker:</span>
</span></span><span class=line><span class=cl><span class=c1># Profile mặc định: docker-default</span>
</span></span><span class=line><span class=cl>docker run --security-opt <span class=nv>apparmor</span><span class=o>=</span>docker-default nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Custom profile:</span>
</span></span><span class=line><span class=cl>docker run --security-opt <span class=nv>apparmor</span><span class=o>=</span>my-nginx-profile nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># USE CASE 4: DESKTOP SANDBOX</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># SELinux:</span>
</span></span><span class=line><span class=cl><span class=c1># Flatpak apps chạy trong sandbox SELinux</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># AppArmor:</span>
</span></span><span class=line><span class=cl><span class=c1># Snap packages dùng AppArmor profiles</span>
</span></span><span class=line><span class=cl>snap install firefox
</span></span><span class=line><span class=cl><span class=c1># Profile tự động tạo và enforce</span></span></span></code></pre></div><hr><h2 class=heading-element id=phần-10-quy-trình-thực-tế><span>PHẦN 10: QUY TRÌNH THỰC TẾ</span>
<a href=#ph%e1%ba%a7n-10-quy-tr%c3%acnh-th%e1%bb%b1c-t%e1%ba%bf class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=101-script-triển-khai-selinux><span>10.1 Script triển khai SELinux</span>
<a href=#101-script-tri%e1%bb%83n-khai-selinux class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># deploy_selinux_service.sh</span>
</span></span><span class=line><span class=cl><span class=c1># Script triển khai service mới với SELinux</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SERVICE_NAME</span><span class=o>=</span><span class=s2>&#34;myapp&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>INSTALL_DIR</span><span class=o>=</span><span class=s2>&#34;/opt/</span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>DATA_DIR</span><span class=o>=</span><span class=s2>&#34;/var/lib/</span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>LOG_DIR</span><span class=o>=</span><span class=s2>&#34;/var/log/</span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CONF_DIR</span><span class=o>=</span><span class=s2>&#34;/etc/</span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PORT</span><span class=o>=</span><span class=s2>&#34;8080&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;═══════════════════════════════════════════════════════&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Triển khai </span><span class=nv>$SERVICE_NAME</span><span class=s2> với SELinux&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;═══════════════════════════════════════════════════════&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 1: Tạo thư mục</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[1/7] Tạo thư mục...&#34;</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=s2>&#34;</span><span class=nv>$INSTALL_DIR</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$DATA_DIR</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$LOG_DIR</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$CONF_DIR</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 2: Định nghĩa file contexts</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[2/7] Định nghĩa file contexts...&#34;</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t bin_t <span class=s2>&#34;</span><span class=nv>$INSTALL_DIR</span><span class=s2>/bin(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t var_lib_t <span class=s2>&#34;</span><span class=nv>$DATA_DIR</span><span class=s2>(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t var_log_t <span class=s2>&#34;</span><span class=nv>$LOG_DIR</span><span class=s2>(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t etc_t <span class=s2>&#34;</span><span class=nv>$CONF_DIR</span><span class=s2>(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 3: Áp dụng contexts</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[3/7] Áp dụng contexts...&#34;</span>
</span></span><span class=line><span class=cl>restorecon -Rv <span class=s2>&#34;</span><span class=nv>$INSTALL_DIR</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$DATA_DIR</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$LOG_DIR</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$CONF_DIR</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 4: Thêm port</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[4/7] Thêm port </span><span class=nv>$PORT</span><span class=s2>...&#34;</span>
</span></span><span class=line><span class=cl>semanage port -a -t http_port_t -p tcp <span class=s2>&#34;</span><span class=nv>$PORT</span><span class=s2>&#34;</span> 2&gt;/dev/null <span class=o>||</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>semanage port -m -t http_port_t -p tcp <span class=s2>&#34;</span><span class=nv>$PORT</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 5: Bật booleans nếu cần</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[5/7] Cấu hình booleans...&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># setsebool -P httpd_can_network_connect on</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 6: Test trong permissive</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[6/7] Test trong permissive mode...&#34;</span>
</span></span><span class=line><span class=cl>semanage permissive -a httpd_t
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Khởi động service và kiểm tra denials:&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;  ausearch -m avc -ts recent&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Khi OK, chạy lệnh sau để enforce:&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;  semanage permissive -d httpd_t&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 7: Hiển thị trạng thái</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[7/7] Trạng thái:&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;File contexts:&#34;</span>
</span></span><span class=line><span class=cl>semanage fcontext -l -C <span class=p>|</span> grep <span class=s2>&#34;</span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span> <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;  (dùng defaults)&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Port:&#34;</span>
</span></span><span class=line><span class=cl>semanage port -l <span class=p>|</span> grep <span class=s2>&#34;</span><span class=nv>$PORT</span><span class=s2>&#34;</span></span></span></code></pre></div><h3 class=heading-element id=102-script-triển-khai-apparmor><span>10.2 Script triển khai AppArmor</span>
<a href=#102-script-tri%e1%bb%83n-khai-apparmor class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># deploy_apparmor_service.sh</span>
</span></span><span class=line><span class=cl><span class=c1># Script triển khai service mới với AppArmor</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>SERVICE_NAME</span><span class=o>=</span><span class=s2>&#34;myapp&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>EXECUTABLE</span><span class=o>=</span><span class=s2>&#34;/usr/bin/</span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PROFILE_NAME</span><span class=o>=</span><span class=s2>&#34;usr.bin.</span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;═══════════════════════════════════════════════════════&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Triển khai </span><span class=nv>$SERVICE_NAME</span><span class=s2> với AppArmor&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;═══════════════════════════════════════════════════════&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 1: Tạo profile skeleton</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[1/5] Tạo profile skeleton...&#34;</span>
</span></span><span class=line><span class=cl>aa-autodep <span class=s2>&#34;</span><span class=nv>$EXECUTABLE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 2: Chuyển complain mode</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[2/5] Chuyển complain mode...&#34;</span>
</span></span><span class=line><span class=cl>aa-complain <span class=s2>&#34;/etc/apparmor.d/</span><span class=nv>$PROFILE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 3: Hướng dẫn test</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[3/5] Test service...&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Trong terminal khác, chạy:&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;  systemctl start </span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;  # Thực hiện mọi thao tác của service&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>read</span> -p <span class=s2>&#34;Nhấn Enter khi đã test xong...&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 4: Cập nhật profile từ log</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[4/5] Cập nhật profile từ log...&#34;</span>
</span></span><span class=line><span class=cl>aa-logprof
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Bước 5: Chuyển enforce</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;[5/5] Chuyển enforce mode...&#34;</span>
</span></span><span class=line><span class=cl>aa-enforce <span class=s2>&#34;/etc/apparmor.d/</span><span class=nv>$PROFILE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Hoàn tất! Kiểm tra trạng thái:&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;  aa-status | grep </span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Nếu có vấn đề:&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;  dmesg | grep apparmor | grep </span><span class=nv>$SERVICE_NAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;  aa-logprof&#34;</span></span></span></code></pre></div><h3 class=heading-element id=103-script-kiểm-tra-bảo-mật><span>10.3 Script kiểm tra bảo mật</span>
<a href=#103-script-ki%e1%bb%83m-tra-b%e1%ba%a3o-m%e1%ba%adt class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># security_audit.sh</span>
</span></span><span class=line><span class=cl><span class=c1># Kiểm tra trạng thái MAC security</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;═══════════════════════════════════════════════════════&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Kiểm tra bảo mật MAC&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;═══════════════════════════════════════════════════════&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Phát hiện MAC system</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -f /sys/fs/selinux/enforce <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>MAC_SYSTEM</span><span class=o>=</span><span class=s2>&#34;selinux&#34;</span>
</span></span><span class=line><span class=cl><span class=k>elif</span> <span class=o>[</span> -d /sys/kernel/security/apparmor <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>MAC_SYSTEM</span><span class=o>=</span><span class=s2>&#34;apparmor&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;CẢNH BÁO: Không phát hiện MAC system!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Hệ thống MAC: </span><span class=nv>$MAC_SYSTEM</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># KIỂM TRA SELINUX</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$MAC_SYSTEM</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;selinux&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;═══ SELINUX ═══&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Chế độ</span>
</span></span><span class=line><span class=cl>    <span class=nv>MODE</span><span class=o>=</span><span class=k>$(</span>getenforce<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Chế độ: </span><span class=nv>$MODE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$MODE</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;Enforcing&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;  ⚠ CẢNH BÁO: Không ở chế độ Enforcing!&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Domains permissive</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Domains trong permissive mode:&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>PERM_DOMAINS</span><span class=o>=</span><span class=k>$(</span>semanage permissive -l 2&gt;/dev/null <span class=p>|</span> grep -v <span class=s2>&#34;^Builtin&#34;</span> <span class=p>|</span> grep -v <span class=s2>&#34;^</span>$<span class=s2>&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$PERM_DOMAINS</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$PERM_DOMAINS</span><span class=s2>&#34;</span> <span class=p>|</span> sed <span class=s1>&#39;s/^/  ⚠ /&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;  ✓ Không có&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Booleans đã thay đổi</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Booleans đã thay đổi từ mặc định:&#34;</span>
</span></span><span class=line><span class=cl>    semanage boolean -l -C 2&gt;/dev/null <span class=p>|</span> head -10 <span class=p>|</span> sed <span class=s1>&#39;s/^/  /&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># File contexts tùy chỉnh</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;File contexts tùy chỉnh:&#34;</span>
</span></span><span class=line><span class=cl>    semanage fcontext -l -C 2&gt;/dev/null <span class=p>|</span> head -10 <span class=p>|</span> sed <span class=s1>&#39;s/^/  /&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Ports tùy chỉnh</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Ports tùy chỉnh:&#34;</span>
</span></span><span class=line><span class=cl>    semanage port -l -C 2&gt;/dev/null <span class=p>|</span> head -10 <span class=p>|</span> sed <span class=s1>&#39;s/^/  /&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Denials gần đây</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;AVC denials gần đây (10 phút):&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>DENIALS</span><span class=o>=</span><span class=k>$(</span>ausearch -m avc -ts <span class=s2>&#34;10 minutes ago&#34;</span> 2&gt;/dev/null <span class=p>|</span> grep <span class=s2>&#34;denied&#34;</span> <span class=p>|</span> wc -l<span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;  Số denials: </span><span class=nv>$DENIALS</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$DENIALS</span><span class=s2>&#34;</span> -gt <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;  Xem chi tiết: ausearch -m avc -ts recent&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl><span class=c1># KIỂM TRA APPARMOR</span>
</span></span><span class=line><span class=cl><span class=c1># ═══════════════════════════════════════════════════════════</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$MAC_SYSTEM</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;apparmor&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;═══ APPARMOR ═══&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Trạng thái tổng quan</span>
</span></span><span class=line><span class=cl>    aa-status --enabled 2&gt;/dev/null <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;Trạng thái: Enabled&#34;</span> <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;Trạng thái: Disabled&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Đếm profiles</span>
</span></span><span class=line><span class=cl>    <span class=nv>ENFORCE</span><span class=o>=</span><span class=k>$(</span>aa-status 2&gt;/dev/null <span class=p>|</span> grep <span class=s2>&#34;profiles are in enforce&#34;</span> <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>COMPLAIN</span><span class=o>=</span><span class=k>$(</span>aa-status 2&gt;/dev/null <span class=p>|</span> grep <span class=s2>&#34;profiles are in complain&#34;</span> <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Profiles enforce: </span><span class=nv>$ENFORCE</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Profiles complain: </span><span class=nv>$COMPLAIN</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$COMPLAIN</span><span class=s2>&#34;</span> -gt <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;  ⚠ CẢNH BÁO: Có profiles trong complain mode!&#34;</span>
</span></span><span class=line><span class=cl>        aa-status 2&gt;/dev/null <span class=p>|</span> grep <span class=s2>&#34;(complain)&#34;</span> <span class=p>|</span> sed <span class=s1>&#39;s/^/    /&#39;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Processes không có profile</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Processes với network không có profile:&#34;</span>
</span></span><span class=line><span class=cl>    aa-unconfined 2&gt;/dev/null <span class=p>|</span> grep -v <span class=s2>&#34;not confined&#34;</span> <span class=p>|</span> head -10 <span class=p>|</span> sed <span class=s1>&#39;s/^/  ⚠ /&#39;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Denials gần đây</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Denials gần đây:&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>DENIALS</span><span class=o>=</span><span class=k>$(</span>dmesg <span class=p>|</span> grep -c <span class=s2>&#34;apparmor.*DENIED&#34;</span> 2&gt;/dev/null <span class=o>||</span> <span class=nb>echo</span> <span class=s2>&#34;0&#34;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;  Số denials trong dmesg: </span><span class=nv>$DENIALS</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$DENIALS</span><span class=s2>&#34;</span> -gt <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;  Xem chi tiết: dmesg | grep apparmor&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;═══════════════════════════════════════════════════════&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Khuyến nghị:&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;═══════════════════════════════════════════════════════&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$MAC_SYSTEM</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;selinux&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$MODE</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;Enforcing&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;• Chuyển SELinux sang Enforcing mode&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$PERM_DOMAINS</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;• Xem xét các domains đang permissive&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$DENIALS</span><span class=s2>&#34;</span> -gt <span class=m>0</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;• Kiểm tra và xử lý AVC denials&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$MAC_SYSTEM</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;apparmor&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$COMPLAIN</span><span class=s2>&#34;</span> -gt <span class=m>0</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;• Chuyển profiles từ complain sang enforce&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></div><hr><h2 class=heading-element id=tóm-tắt-nhanh><span>TÓM TẮT NHANH</span>
<a href=#t%c3%b3m-t%e1%ba%aft-nhanh class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=lệnh-selinux><span>Lệnh SELinux</span>
<a href=#l%e1%bb%87nh-selinux class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Trạng thái</span>
</span></span><span class=line><span class=cl>getenforce                      <span class=c1># Xem chế độ</span>
</span></span><span class=line><span class=cl>sestatus                        <span class=c1># Chi tiết</span>
</span></span><span class=line><span class=cl>setenforce 0<span class=p>|</span><span class=m>1</span>                  <span class=c1># Permissive|Enforcing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Context</span>
</span></span><span class=line><span class=cl>ls -Z                           <span class=c1># Xem file context</span>
</span></span><span class=line><span class=cl>ps auxZ                         <span class=c1># Xem process context</span>
</span></span><span class=line><span class=cl>id -Z                           <span class=c1># Xem user context</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Gán nhãn</span>
</span></span><span class=line><span class=cl>chcon -t TYPE file              <span class=c1># Tạm thời</span>
</span></span><span class=line><span class=cl>restorecon -Rv path             <span class=c1># Khôi phục</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t TYPE <span class=s2>&#34;path(/.*)?&#34;</span>  <span class=c1># Vĩnh viễn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Booleans</span>
</span></span><span class=line><span class=cl>getsebool -a                    <span class=c1># Liệt kê</span>
</span></span><span class=line><span class=cl>setsebool -P boolean on         <span class=c1># Bật vĩnh viễn</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ports</span>
</span></span><span class=line><span class=cl>semanage port -l                <span class=c1># Liệt kê</span>
</span></span><span class=line><span class=cl>semanage port -a -t TYPE -p tcp PORT  <span class=c1># Thêm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Debug</span>
</span></span><span class=line><span class=cl>ausearch -m avc -ts recent      <span class=c1># Tìm denials</span>
</span></span><span class=line><span class=cl>audit2why                       <span class=c1># Giải thích</span>
</span></span><span class=line><span class=cl>sealert -a /var/log/audit/audit.log  <span class=c1># Phân tích</span></span></span></code></pre></div><h3 class=heading-element id=lệnh-apparmor><span>Lệnh AppArmor</span>
<a href=#l%e1%bb%87nh-apparmor class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Trạng thái</span>
</span></span><span class=line><span class=cl>aa-status                       <span class=c1># Tổng quan</span>
</span></span><span class=line><span class=cl>cat /sys/kernel/security/apparmor/profiles  <span class=c1># Profiles</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Chế độ</span>
</span></span><span class=line><span class=cl>aa-enforce profile              <span class=c1># Enforce</span>
</span></span><span class=line><span class=cl>aa-complain profile             <span class=c1># Complain</span>
</span></span><span class=line><span class=cl>aa-disable profile              <span class=c1># Vô hiệu</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Load profiles</span>
</span></span><span class=line><span class=cl>apparmor_parser -r profile      <span class=c1># Reload</span>
</span></span><span class=line><span class=cl>apparmor_parser -a profile      <span class=c1># Load mới</span>
</span></span><span class=line><span class=cl>apparmor_parser -R profile      <span class=c1># Unload</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Tạo/cập nhật</span>
</span></span><span class=line><span class=cl>aa-genprof /path/to/app         <span class=c1># Tạo mới</span>
</span></span><span class=line><span class=cl>aa-logprof                      <span class=c1># Cập nhật từ log</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Debug</span>
</span></span><span class=line><span class=cl>dmesg <span class=p>|</span> grep apparmor           <span class=c1># Xem violations</span>
</span></span><span class=line><span class=cl>aa-unconfined                   <span class=c1># Processes không có profile</span></span></span></code></pre></div><h3 class=heading-element id=hướng-dẫn-chọn-nhanh><span>Hướng dẫn chọn nhanh</span>
<a href=#h%c6%b0%e1%bb%9bng-d%e1%ba%abn-ch%e1%bb%8dn-nhanh class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>┌───────────────────────────────────────────────────────────────┐
</span></span><span class=line><span class=cl>│ Vấn đề                      │ SELinux            │ AppArmor   │
</span></span><span class=line><span class=cl>├─────────────────────────────┼────────────────────┼────────────┤
</span></span><span class=line><span class=cl>│ File access bị chặn         │ restorecon         │ aa-logprof │
</span></span><span class=line><span class=cl>│ Network bị chặn             │ setsebool          │ Thêm luật  │
</span></span><span class=line><span class=cl>│ Port bị chặn                │ semanage port      │ Thêm luật  │
</span></span><span class=line><span class=cl>│ Service mới                 │ semanage fcontext  │ aa-genprof │
</span></span><span class=line><span class=cl>│ Debug                       │ audit2why          │ aa-logprof │
</span></span><span class=line><span class=cl>│ Tạm tắt cho app             │ semanage permissive│ aa-complain│
</span></span><span class=line><span class=cl>└─────────────────────────────┴────────────────────┴────────────┘</span></span></code></pre></div></div><hr class=awesome-hr><h2 id=see-also>Nội dung liên quan</h2><ul><li><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/encryption-and-security/ title="Linux Cryptography & Security Tools - Hướng Dẫn Chuyên Sâu">Linux Cryptography & Security Tools - Hướng Dẫn Chuyên Sâu</a></li><li><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/package-manager/ title="Linux Package Management - Hướng Dẫn Chuyên Sâu">Linux Package Management - Hướng Dẫn Chuyên Sâu</a></li><li><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/user-group/ title="Linux User & Group Management - Hướng Dẫn Chuyên Sâu">Linux User & Group Management - Hướng Dẫn Chuyên Sâu</a></li><li><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/storage/ title="Disk, Storage & Filesystem - Hướng Dẫn Chuyên Sâu">Disk, Storage & Filesystem - Hướng Dẫn Chuyên Sâu</a></li><li><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/regex-awk-sed/ title="Awk, Sed & Regex - Hướng Dẫn Chuyên Sâu Cho System Engineer">Awk, Sed & Regex - Hướng Dẫn Chuyên Sâu Cho System Engineer</a></li></ul><div class=collection-card><div class="collection-title text-secondary">Trong <a href=/collections/linux-cli/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>Bộ sưu tập・Linux Cli</span></span></a> 11</div><div class=collection-nav><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/package-manager/ class=collection-nav-item rel=prev title="Linux Package Management - Hướng Dẫn Chuyên Sâu"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i><span>Linux Package Management - Hướng Dẫn Chuyên Sâu</span>
</a><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/file-and-folder/ class=collection-nav-item rel=next title="Find, Ln, Lsof, Tar, Chmod - Hướng Dẫn Chuyên Sâu"><span>Find, Ln, Lsof, Tar, Chmod - Hướng Dẫn Chuyên Sâu</span><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="Cập nhật ngày 2025-12-11 16:05:24">Cập nhật ngày 2025-12-11&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Chia sẻ trên X" data-sharer=twitter data-url=https://vanvuvuong.github.io/bai-viet/khoa-hoc-may-tinh/linux-cli/selinux/ data-title="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc" data-hashtags="ai generated post"><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Chia sẻ trên Facebook" data-sharer=facebook data-url=https://vanvuvuong.github.io/bai-viet/khoa-hoc-may-tinh/linux-cli/selinux/ data-hashtag="ai generated post"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="Chia sẻ trên 微博" data-sharer=weibo data-url=https://vanvuvuong.github.io/bai-viet/khoa-hoc-may-tinh/linux-cli/selinux/ data-title="Selinux & Apparmor - Kiểm Soát Truy Cập Bắt Buộc"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/ai-generated-post/ class=post-tag title="Nhãn - Ai Generated Post">Ai Generated Post</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Quay lại</a></span>&nbsp;|&nbsp;<span><a href=/>Trang chủ</a></span></section></div><div class=post-nav><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/encryption-and-security/ class=post-nav-item rel=prev title="Linux Cryptography & Security Tools - Hướng Dẫn Chuyên Sâu"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Linux Cryptography & Security Tools - Hướng Dẫn Chuyên Sâu</a><a href=/bai-viet/khoa-hoc-may-tinh/linux-cli/file-and-folder/ class=post-nav-item rel=next title="Find, Ln, Lsof, Tar, Chmod - Hướng Dẫn Chuyên Sâu">Find, Ln, Lsof, Tar, Chmod - Hướng Dẫn Chuyên Sâu<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article><aside class=toc id=toc-auto aria-label="Nội dung"><h2 class=toc-title>Nội dung&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><dialog id=toc-dialog aria-labelledby=toc-dialog-title role=dialog><div class=toc><h2 class=toc-title>Nội dung</h2><div class=toc-content id=toc-content-drawer><nav><ul><li><ul><li><a href=#phần-1-nền-tảng-mac>PHẦN 1: NỀN TẢNG MAC</a><ul><li><a href=#11-dac-vs-mac>1.1 DAC vs MAC</a></li><li><a href=#12-mô-hình-bảo-mật>1.2 Mô hình bảo mật</a></li><li><a href=#13-linux-security-modules-lsm>1.3 Linux Security Modules (LSM)</a></li></ul></li><li><a href=#phần-2-kiến-trúc-selinux>PHẦN 2: KIẾN TRÚC SELINUX</a><ul><li><a href=#21-thành-phần-cốt-lõi>2.1 Thành phần cốt lõi</a></li><li><a href=#22-security-context>2.2 Security Context</a></li><li><a href=#23-type-enforcement>2.3 Type Enforcement</a></li><li><a href=#24-file-context-database>2.4 File Context Database</a></li></ul></li><li><a href=#phần-3-vận-hành-selinux>PHẦN 3: VẬN HÀNH SELINUX</a><ul><li><a href=#31-chế-độ-selinux>3.1 Chế độ SELinux</a></li><li><a href=#32-policy-types>3.2 Policy Types</a></li><li><a href=#33-booleans>3.3 Booleans</a></li><li><a href=#34-port-context>3.4 Port Context</a></li><li><a href=#35-user-mappings>3.5 User Mappings</a></li></ul></li><li><a href=#phần-4-xử-lý-sự-cố-selinux>PHẦN 4: XỬ LÝ SỰ CỐ SELINUX</a><ul><li><a href=#41-tìm-avc-denials>4.1 Tìm AVC Denials</a></li><li><a href=#42-công-cụ-phân-tích>4.2 Công cụ phân tích</a></li><li><a href=#43-quy-trình-xử-lý-sự-cố>4.3 Quy trình xử lý sự cố</a></li><li><a href=#44-vấn-đề-phổ-biến-và-giải-pháp>4.4 Vấn đề phổ biến và giải pháp</a></li></ul></li><li><a href=#phần-5-viết-policy-selinux>PHẦN 5: VIẾT POLICY SELINUX</a><ul><li><a href=#51-cấu-trúc-module>5.1 Cấu trúc Module</a></li><li><a href=#52-sử-dụng-audit2allow-an-toàn>5.2 Sử dụng audit2allow an toàn</a></li></ul></li><li><a href=#phần-6-kiến-trúc-apparmor>PHẦN 6: KIẾN TRÚC APPARMOR</a><ul><li><a href=#61-pathname-based-mac>6.1 Pathname-based MAC</a></li><li><a href=#62-thành-phần-apparmor>6.2 Thành phần AppArmor</a></li><li><a href=#63-chế-độ-profile>6.3 Chế độ Profile</a></li><li><a href=#64-cú-pháp-profile>6.4 Cú pháp Profile</a></li></ul></li><li><a href=#phần-7-vận-hành-apparmor>PHẦN 7: VẬN HÀNH APPARMOR</a><ul><li><a href=#71-quản-lý-chế-độ>7.1 Quản lý chế độ</a></li><li><a href=#72-tạo-profile-mới>7.2 Tạo profile mới</a></li><li><a href=#73-cập-nhật-profile>7.3 Cập nhật profile</a></li><li><a href=#74-xem-và-debug-violations>7.4 Xem và debug violations</a></li></ul></li><li><a href=#phần-8-viết-profile-apparmor>PHẦN 8: VIẾT PROFILE APPARMOR</a><ul><li><a href=#81-profile-hoàn-chỉnh>8.1 Profile hoàn chỉnh</a></li><li><a href=#82-abstractions>8.2 Abstractions</a></li><li><a href=#83-tunables>8.3 Tunables</a></li><li><a href=#84-local-customizations>8.4 Local customizations</a></li></ul></li><li><a href=#phần-9-so-sánh--trường-hợp-sử-dụng>PHẦN 9: SO SÁNH & TRƯỜNG HỢP SỬ DỤNG</a><ul><li><a href=#91-bảng-so-sánh-chi-tiết>9.1 Bảng so sánh chi tiết</a></li><li><a href=#92-khi-nào-dùng-gì>9.2 Khi nào dùng gì</a></li><li><a href=#93-so-sánh-theo-use-case>9.3 So sánh theo use case</a></li></ul></li><li><a href=#phần-10-quy-trình-thực-tế>PHẦN 10: QUY TRÌNH THỰC TẾ</a><ul><li><a href=#101-script-triển-khai-selinux>10.1 Script triển khai SELinux</a></li><li><a href=#102-script-triển-khai-apparmor>10.2 Script triển khai AppArmor</a></li><li><a href=#103-script-kiểm-tra-bảo-mật>10.3 Script kiểm tra bảo mật</a></li></ul></li><li><a href=#tóm-tắt-nhanh>TÓM TẮT NHANH</a><ul><li><a href=#lệnh-selinux>Lệnh SELinux</a></li><li><a href=#lệnh-apparmor>Lệnh AppArmor</a></li><li><a href=#hướng-dẫn-chọn-nhanh>Hướng dẫn chọn nhanh</a></li></ul></li></ul></li></ul></nav></div></div></dialog></main><footer class=footer><div class=footer-container><div class="footer-line powered">Cung cấp bởi <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.152.0"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> | Chủ đề - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.4.0-alpha.2"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2025</span></div></div></footer></div><div class=widgets><div class=fixed-buttons><div class="fixed-button back-to-top animate__faster" role=button aria-label="Lên trên"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><svg viewBox="0 0 100 100"><circle class="bg" cx="50" cy="50" r="50"/><circle class="progress" cx="50" cy="50" r="50"/></svg></div><div id=toc-drawer-button class="fixed-button toc-drawer-button" role=button aria-label="Nội dung"><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></div></div><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#000;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>Trang web này hoạt động tốt nhất khi JavaScript được kích hoạt.</div></noscript></div><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><link rel=stylesheet href=/lib/pace/themes/blue/pace-theme-minimal.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pace/pace.min.js async defer></script><script src=/bai-viet/khoa-hoc-may-tinh/linux-cli/selinux/config/page.js defer></script><script src=/js/theme.min.js defer></script></body></html>